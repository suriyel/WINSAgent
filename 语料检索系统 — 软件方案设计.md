# 语料检索系统 — 软件方案设计

## Context

当前 WINS Agent 的知识系统仅支持手动编写的 Markdown 文件，使用 `FakeEmbeddings` + FAISS 做基础向量检索，无 Rerank、无异构文档解析、无图文关联。需求文档要求构建一套完整的电信网规网优专业语料检索系统，支持 Word/PDF/PPT/Excel 全量解析、高精度检索（向量+重排序）、超大 MD 预览定位、图文关联及专家治理。

**技术选型决策**:

- **Embedding**: 远程 API（复用 LLM_BASE_URL 的 OpenAI 兼容接口，如 Qwen text-embedding）
- **Reranker**: 远程 API（通过 HTTP 调用 Reranker 服务，而非本地加载模型）
- **前端预览**: 右侧 Panel 替换（点击引用时 TaskPanel 区域切换为 CorpusViewer）

------

## 模块拆解与实现方案

### M1: 全量构建流水线（P0）

**目标**: 异构文档(Word/PDF/PPT/Excel) → Markdown(含图片占位) → 段落切片 → 向量化 → FAISS 索引

**方案**:

1. **新增 `backend/app/knowledge/pipeline.py`** — 构建流水线主入口

   - `CorpusPipeline` 类：管理解析 → 切片 → 入库全流程
   - 全量构建时：先清空已有索引 → 解析所有文件 → 重建索引
   - 构建期间设置 `is_building` 标志，查询 API 返回 503

2. **新增 `backend/app/knowledge/parsers/` 目录** — 文档解析器

   - ```
     docling_parser.py
     ```

     : 基于 Docling 引擎解析 Word/PDF/PPT → Markdown

     - 提取图片保存至 `corpus_store/images/`，在 MD 中生成 `![alt](images/xxx.png)` 占位
     - 保留文档结构层级（标题、段落、表格）

   - ```
     excel_parser.py
     ```

     : 基于 Pandas 将 Excel → Standard Markdown Table

     - 每个 Sheet 独立转为一个 MD 文件
     - 保留行列关系，表头识别

3. **新增 `backend/app/knowledge/chunker.py`** — 改进的段落切片器

   - 基于 Markdown heading 结构做语义切片（优于纯字符数切片）
   - 保留完整段落，chunk 元数据包含：`source_file`, `heading_path`, `chunk_index`, `page_range`, `has_images`
   - 切片粒度：800~1200 字符，标题层级作为主分隔符

4. **改造 `backend/app/knowledge/vector_store.py`**

   - 新增 `corpus_store`（统一语料库索引），与现有 `terminology_store` / `design_doc_store` 并存
   - 替换 `FakeEmbeddings` → 远程 Embedding API（通过 `langchain-openai` 的 `OpenAIEmbeddings`，复用 LLM_BASE_URL）
   - `rebuild_corpus()` 方法：调用 Pipeline 全量重建

5. **改造 `backend/app/config.py`** — 新增配置项:

   

   ```
   CORPUS_SOURCE_DIR    # 源文件目录（Word/PDF/PPT/Excel）
   CORPUS_MD_DIR        # 解析后 MD 存储目录
   CORPUS_IMAGE_DIR     # 提取的图片存储目录
   EMBEDDING_MODEL      # Embedding 模型标识（如 text-embedding-v3）
   EMBEDDING_API_KEY    # Embedding API Key（默认复用 LLM_API_KEY）
   EMBEDDING_BASE_URL   # Embedding API 地址（默认复用 LLM_BASE_URL）
   RERANKER_MODEL       # Reranker 模型标识（如 bge-reranker-v2-m3）
   RERANKER_BASE_URL    # Reranker API 地址
   RERANKER_API_KEY     # Reranker API Key
   RERANKER_THRESHOLD   # 拒答阈值（默认 0.3）
   ```

6. **新增 API `POST /api/corpus/build`** — 触发全量构建

   - 返回 202 Accepted + task_id
   - 通过 SSE 推送构建进度事件 `corpus.build_progress`

**新增依赖**: `docling`, `pandas`, `openpyxl`

**修改文件**:

- `backend/app/knowledge/vector_store.py` (改造)
- `backend/app/knowledge/loader.py` (改造，新增解析器调用)
- `backend/app/config.py` (新增配置)
- `backend/app/main.py` (注册新 router)
- `backend/requirements.txt` (新增依赖)

**新增文件**:

- `backend/app/knowledge/pipeline.py`
- `backend/app/knowledge/parsers/__init__.py`
- `backend/app/knowledge/parsers/docling_parser.py`
- `backend/app/knowledge/parsers/excel_parser.py`
- `backend/app/knowledge/chunker.py`
- `backend/app/api/corpus_api.py`

------

### M2: 高精度检索 — FAISS + BGE-Reranker（P0）

**目标**: 向量召回 + BGE-Reranker 重排序 + 专家词表强制干预

**方案**:

1. **新增 `backend/app/knowledge/reranker.py`** — 重排序引擎
   - 通过 HTTP 调用远程 Reranker API（如 Jina Reranker、SiliconFlow BGE-Reranker 等 OpenAI 兼容接口）
   - 配置项：`RERANKER_BASE_URL`, `RERANKER_API_KEY`, `RERANKER_MODEL`
   - `rerank(query, candidates, top_k)` 方法
   - 专家词表干预逻辑：若 query 包含术语表中的术语，对包含该术语的候选文档做 score boost
   - 低分拒答：Rerank 最高分 < 阈值（可配置，默认 0.3）时，返回"语料库中未找到相关准确依据"
2. **新增 `backend/app/knowledge/glossary.py`** — 专家词表管理
   - 加载 JSON/CSV 格式的术语库和同义词映射表
   - `GlossaryManager`：内存缓存词表，提供 `expand_query(query)` 做同义词扩展
   - 持久化到 `corpus_store/glossary/` 目录
3. **改造 `backend/app/agent/tools/knowledge.py`** — 新增/改造检索工具
   - 新增 `search_corpus` tool：向量召回 top_k=20 → Reranker 重排 → 返回 top_3
   - 返回结果包含：`source_file`, `heading_path`, `content`, `score`, `chunk_id`（用于前端锚点定位）
   - 保留现有 `search_terminology` / `search_design_doc`（向下兼容）
4. **改造 `backend/app/agent/tools/registry.py`** — 注册新工具

**新增依赖**: `httpx>=0.27.0`（用于异步调用 Reranker API）

**修改文件**:

- `backend/app/agent/tools/knowledge.py` (新增 search_corpus)
- `backend/app/agent/tools/registry.py` (注册)
- `backend/requirements.txt`

**新增文件**:

- `backend/app/knowledge/reranker.py`
- `backend/app/knowledge/glossary.py`

------

### M3: 超大 MD 预览与锚点定位（P0）

**目标**: 前端支持 10MB+ MD 文件虚拟滚动预览，点击引用跳转并高亮

**方案**:

1. **新增后端 API**:

   - `GET /api/corpus/files` — 列出语料库中所有已解析的 MD 文件

   - ```
     GET /api/corpus/files/{file_id}
     ```

      

     — 分页返回 MD 文件内容（按段落/chunk 分页）

     - 参数：`offset`, `limit`, `anchor`（锚点 chunk_id，返回该 chunk 附近内容）

   - `GET /api/corpus/files/{file_id}/meta` — 返回文件元信息（大小、chunk 数、heading 结构）

   - 静态文件服务：`/corpus/images/` 挂载图片目录

2. **新增前端组件 `frontend/src/components/corpus/`**:

   - ```
     CorpusViewer.tsx
     ```

      

     — 主预览容器

     - 使用 `react-virtuoso` 实现虚拟滚动（严禁一次性加载完整 DOM）
     - 接收 `file_id` + `anchor_chunk_id` 参数

   - ```
     CorpusChunk.tsx
     ```

      

     — 单个 chunk 渲染组件

     - 使用 `react-markdown` 渲染 Markdown
     - 支持关键词背景高亮（CSS `mark` 标签）

   - `CorpusFileList.tsx` — 语料文件列表

   - `CorpusSidebar.tsx` — 文件 heading 目录树（快速导航）

3. **改造前端 Layout（右侧 Panel 替换）**:

   - 在 `ChatArea` 的 `MessageBubble` 中，检索结果的 `source` 字段渲染为可点击引用标签 `[1]`
   - 点击后右侧 `TaskPanel` 区域切换为 `CorpusViewer`，自动跳转到对应 chunk 锚点并高亮
   - Panel 顶部显示文件名 + 返回按钮（切回 TaskPanel）
   - 改造 `WorkstationLayout.tsx`：Panel 区域根据 `corpusStore.activeFile` 条件渲染

4. **新增前端 store**:

   - ```
     frontend/src/stores/corpusStore.ts
     ```

      

     — 管理语料预览状态

     - `activeFile`: 当前打开的文件 ID
     - `anchorChunkId`: 锚点 chunk ID
     - `highlightKeywords`: 高亮关键词列表
     - `openCorpusViewer(fileId, chunkId, keywords)` / `closeCorpusViewer()` actions

**新增依赖（前端）**: `react-virtuoso`, `react-markdown`, `remark-gfm`

**修改文件**:

- `frontend/src/components/chat/MessageBubble.tsx` (引用链接可点击)
- `frontend/src/components/layout/WorkstationLayout.tsx` (Panel 条件渲染)
- `frontend/package.json` (新增依赖)
- `backend/app/main.py` (注册 router + 静态文件)

**新增文件**:

- `backend/app/api/corpus_api.py` (扩展文件预览 API)
- `frontend/src/components/corpus/CorpusViewer.tsx`
- `frontend/src/components/corpus/CorpusChunk.tsx`
- `frontend/src/components/corpus/CorpusFileList.tsx`
- `frontend/src/components/corpus/CorpusSidebar.tsx`
- `frontend/src/stores/corpusStore.ts`

------

### M4: 图文关联系统（P1）

**目标**: 提取文档图片，保留 MD 占位符，报告中自动附带图片引用

**方案**:

1. **Docling 解析阶段（M1 已覆盖）**:
   - 解析时提取图片到 `corpus_store/images/{source_file_hash}/`
   - MD 中生成 `![图片描述](images/{hash}/{img_name})` 占位符
   - 记录图片上下文元数据：前后段落摘要
2. **检索结果增强**:
   - 检索命中的 chunk 若包含图片占位符，返回结果中附带 `image_refs` 列表
   - 前端 `CorpusChunk.tsx` 渲染时自动解析图片引用并展示
3. **Agent 生成报告时**:
   - 在 Skill 的 system_prompt 中增加指引：结论相关的 chunk 若有图片引用，在结论后附带图片
   - 前端 `MessageBubble` 支持渲染 Markdown 图片标签

**修改文件**:

- `backend/app/knowledge/parsers/docling_parser.py` (图片提取逻辑，M1 中一并实现)
- `frontend/src/components/corpus/CorpusChunk.tsx` (图片渲染)
- `frontend/src/components/chat/MessageBubble.tsx` (报告中图片渲染)

------

### M5: 专家治理入口（P1）

**目标**: 支持 JSON/CSV 上传术语库和同义词映射表

**方案**:

1. **新增后端 API**:

   - `POST /api/corpus/glossary/upload` — 上传术语库（JSON/CSV）
   - `GET /api/corpus/glossary` — 查看当前术语库
   - `DELETE /api/corpus/glossary/{id}` — 删除术语条目

2. **新增前端页面**:

   - ```
     frontend/src/components/corpus/GlossaryManager.tsx
     ```

      

     — 术语治理界面

     - 文件上传组件（支持 JSON/CSV）
     - 术语列表展示（表格形式）
     - 同义词映射编辑

3. **与 Reranker 集成**: 上传的词表实时更新 `GlossaryManager` 内存缓存，影响后续检索的 Rerank 得分

**新增文件**:

- `backend/app/api/corpus_api.py` (扩展术语管理 API)
- `frontend/src/components/corpus/GlossaryManager.tsx`

------

## 数据流全景



```
源文件 (Word/PDF/PPT/Excel)
    │
    ▼
[Docling 解析] + [Pandas Excel 解析]
    │
    ▼
Markdown 文件 (含图片占位符)  ──→  图片文件 (images/)
    │
    ▼
[语义段落切片器]
    │
    ▼
Document Chunks (带结构化元数据)
    │
    ▼
[Embedding 向量化]
    │
    ▼
FAISS 索引 (corpus_store)
    │
    ▼
[用户查询] → FAISS 向量召回 (top_20)
    │
    ▼
[BGE-Reranker 重排序] + [专家词表 boost]
    │
    ▼
Top_3 结果 (带溯源信息)
    │
    ▼
[前端展示] → 引用链接 → CorpusViewer 虚拟滚动 + 锚点高亮
```

------

## 目录结构变更



```
backend/app/knowledge/
├── __init__.py
├── vector_store.py       # 改造：新增 corpus_store
├── loader.py             # 改造：支持调用解析器
├── pipeline.py           # 新增：构建流水线
├── chunker.py            # 新增：语义切片器
├── reranker.py           # 新增：远程 Reranker API 客户端
├── glossary.py           # 新增：专家词表管理
└── parsers/
    ├── __init__.py
    ├── docling_parser.py # 新增：Docling 解析
    └── excel_parser.py   # 新增：Excel 解析

backend/app/api/
├── corpus_api.py         # 新增：语料管理 API

frontend/src/components/corpus/
├── CorpusViewer.tsx      # 新增：虚拟滚动预览
├── CorpusChunk.tsx       # 新增：chunk 渲染
├── CorpusFileList.tsx    # 新增：文件列表
├── CorpusSidebar.tsx     # 新增：heading 导航
└── GlossaryManager.tsx   # 新增：术语治理
```

------

## 新增依赖汇总

**Backend (`requirements.txt`)**:



```
docling>=2.0.0
pandas>=2.0.0
openpyxl>=3.1.0
httpx>=0.27.0
```

**Frontend (`package.json`)**:



```
react-virtuoso
react-markdown
remark-gfm
```

------

## 实施顺序

| 阶段    | 模块              | 优先级 | 依赖关系                        |
| ------- | ----------------- | ------ | ------------------------------- |
| Phase 1 | M1 全量构建流水线 | P0     | 无                              |
| Phase 2 | M2 高精度检索     | P0     | 依赖 M1（需要有索引数据）       |
| Phase 3 | M3 超大 MD 预览   | P0     | 依赖 M1（需要已解析的 MD 文件） |
| Phase 4 | M4 图文关联       | P1     | 依赖 M1 + M3                    |
| Phase 5 | M5 专家治理       | P1     | 依赖 M2（需要 Reranker 就位）   |

------

## 验证方案

1. **M1 验证**: 准备 3-5 份测试文档（各类型），执行 `POST /api/corpus/build`，检查生成的 MD 文件完整性和图片提取
2. **M2 验证**: 用已知术语查询，验证 Top3 Precision ≥ 80%；验证无关查询返回拒答
3. **M3 验证**: 生成 10MB+ 的 MD 文件，前端虚拟滚动流畅（FPS ≥ 30），锚点跳转正确
4. **M4 验证**: 含图文档解析后，图片正确显示，报告中图片引用正确
5. **M5 验证**: 上传术语 CSV，验证检索结果排序受术语干预影响
6. **单元测试**: 每个模块新增对应测试文件在 `backend/tests/`