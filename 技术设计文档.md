# AI Agent å·¥ä½œå° - æŠ€æœ¯è®¾è®¡æ–‡æ¡£

> åŸºäº LangChain 1.2.5 çš„æ™ºèƒ½ä»£ç†å·¥ä½œå°ç³»ç»ŸæŠ€æœ¯è§£å†³æ–¹æ¡ˆä¸å¼€å‘è®¡åˆ’

---

## ä¸€ã€è§£å†³æ–¹æ¡ˆ

### 1. ç³»ç»Ÿæ¦‚è¿°

- **ç³»ç»Ÿå®šä½**ï¼šé¢å‘å­˜é‡ç³»ç»Ÿé›†æˆçš„ AI Agent å·¥ä½œå°ï¼Œä½œä¸ºç”¨æˆ·ä¸100+å­˜é‡ç³»ç»Ÿ API ä¹‹é—´çš„æ™ºèƒ½ç¼–æ’å±‚ï¼Œè‡ªåŠ¨ç†è§£ç”¨æˆ·æ„å›¾ã€æ£€ç´¢é¢†åŸŸçŸ¥è¯†ã€ç»„æ’ Tool è°ƒç”¨é“¾å¹¶ä»¥å¯è§†åŒ–æ–¹å¼å‘ˆç°æ‰§è¡Œè¿‡ç¨‹ã€‚

- **æ ¸å¿ƒèƒ½åŠ›çŸ©é˜µ**ï¼š

| èƒ½åŠ›åŸŸ | æ ¸å¿ƒåŠŸèƒ½ | æŠ€æœ¯æ”¯æ’‘ |
| :--- | :--- | :--- |
| æ„å›¾ç†è§£ | è‡ªç„¶è¯­è¨€æ„å›¾è¯†åˆ«ä¸Toolæ˜ å°„ | LangChain 1.2.5 `create_agent` + LLM tool binding |
| é¢†åŸŸçŸ¥è¯† | ä¸“ä¸šæœ¯è¯­è¡¨/è®¾è®¡æ–‡æ¡£çš„å‘é‡æ£€ç´¢ | FAISS + `langchain-community` VectorStore |
| Toolç¼–æ’ | 100ä»¥å†…Toolçš„ä¾èµ–å…³ç³»ç®¡ç†ä¸ä¸²è¡Œè°ƒç”¨ | `@tool` è£…é¥°å™¨ + descriptionä¾èµ–æ¨æ–­ |
| ä»»åŠ¡åˆ†å‘ | å§”æ´¾å¼/å“åº”å¼å­ Agent ç»Ÿä¸€ç®¡ç† | `SubAgentMiddleware` + `task()` tool è‡ªåŠ¨æ„å»º |
| äººæœºäº¤äº’ | Toolè°ƒç”¨å‰çš„approve/edit/reject | `HumanInTheLoopMiddleware` |
| æµå¼è¾“å‡º | Tokençº§å®æ—¶æ¨é€ | SSE + `agent.stream()` |
| TODOç®¡ç† | æ­¥éª¤çŠ¶æ€è·Ÿè¸ªä¸å¯è§†åŒ– | `todo_tracker` å“åº”å¼å­ Agentï¼ˆ`SubAgentMiddleware`ï¼‰ |

- **è®¾è®¡çº¦æŸ**ï¼š
    - åŠŸèƒ½çº¦æŸï¼šä¸æ”¯æŒå¹¶è¡ŒToolè°ƒç”¨ï¼›Tool/TODOæ­¥éª¤å¤±è´¥ä¸é‡è¯•ä¸å›æ»šï¼Œç›´æ¥ç»ˆæ­¢ä»»åŠ¡
    - æ€§èƒ½è§„æ ¼ï¼šFAISSæ£€ç´¢ â‰¤ 500msï¼ŒSSEå»¶è¿Ÿ â‰¤ 100msï¼Œé…ç½®é¢æ¿å“åº” â‰¤ 1s
    - æŠ€æœ¯çº¦æŸï¼šå¿…é¡»åŸºäº LangChain 1.2.5ï¼Œä¼˜å…ˆä½¿ç”¨æ¡†æ¶åŸç”Ÿç‰¹æ€§

---

### 2. ä¸‰æ–¹ä»¶é€‰å‹ä¸å…¼å®¹æ€§åˆ†æ

#### 2.1 é€‰å‹å†³ç­–è®°å½• (ADR)

| ç»„ä»¶ç±»åˆ« | å¾…é€‰æ–¹æ¡ˆ | æœ€ç»ˆé€‰å‹ | ç†ç”± (Why) | æ½œåœ¨é£é™© |
| :--- | :--- | :--- | :--- | :--- |
| Agentæ¡†æ¶ | LangChain 1.2.5 vs LlamaIndex vs è‡ªç ” | **LangChain 1.2.5** | éœ€æ±‚å¼ºåˆ¶æŒ‡å®šï¼›æä¾› `create_agent`ã€`middleware`ã€`stream` åŸç”Ÿæ”¯æŒ | 1.2.5ä¸ºæ–°ç‰ˆæœ¬ï¼Œç¤¾åŒºæ¡ˆä¾‹æœ‰é™ |
| å‘é‡æ£€ç´¢ | FAISS vs ChromaDB vs Milvus | **FAISS (faiss-cpu)** | éœ€æ±‚æŒ‡å®šï¼›è½»é‡çº§ã€æ— éœ€ç‹¬ç«‹éƒ¨ç½²ã€ä¸ langchain-community é›†æˆæˆç†Ÿ | å•æœºæ€§èƒ½ä¸Šé™ï¼Œä¸æ”¯æŒåˆ†å¸ƒå¼ |
| Embeddingæ¨¡å‹ | OpenAI Embedding vs HuggingFace | **å¾…å®šï¼ˆè·ŸéšLLMé€‰å‹ï¼‰** | éœ€ä¸LLMæä¾›å•†ä¿æŒä¸€è‡´æ€§ | å¤šæ¨¡å‹æ··ç”¨å¢åŠ è¿ç»´æˆæœ¬ |
| æŒä¹…åŒ–å­˜å‚¨ | MySQL vs PostgreSQL vs SQLite | **MySQL** | éœ€æ±‚æŒ‡å®šï¼›FAISS Indexä»¥BLOBå­˜å‚¨ï¼›éªŒè¯é˜¶æ®µç”¨ `InMemorySaver` | BLOBå­—æ®µæŸ¥è¯¢æ•ˆç‡éœ€å…³æ³¨ |
| å‰ç«¯æ¡†æ¶ | React vs Vue vs Svelte | **React + Tailwind CSS** | éœ€æ±‚æŒ‡å®šï¼›ç”Ÿæ€æˆç†Ÿï¼ŒTailwindç¬¦åˆUCDè®¾è®¡è§„èŒƒçš„åŸå­åŒ–éœ€æ±‚ | æ—  |
| åç«¯æ¡†æ¶ | FastAPI vs Flask vs Django | **FastAPI** | åŸç”Ÿæ”¯æŒSSEï¼ˆ`StreamingResponse`ï¼‰ã€asyncã€ç±»å‹å®‰å…¨ | éœ€å¼•å…¥ `uvicorn` ä½œä¸º ASGI æœåŠ¡å™¨ |
| çŠ¶æ€ç®¡ç†(å‰ç«¯) | Zustand vs Redux vs Jotai | **Zustand** | è½»é‡çº§ã€APIç®€æ´ã€ä¸SSEäº‹ä»¶é©±åŠ¨æ¨¡å¼å¥‘åˆ | ç¤¾åŒºè§„æ¨¡å°äºRedux |
| Checkpointer | InMemorySaver vs MySQL Saver | **InMemorySaverï¼ˆéªŒè¯é˜¶æ®µï¼‰** | LangChain 1.2.5 åŸç”Ÿæä¾›ï¼›ç”Ÿäº§é˜¶æ®µè¿ç§»è‡³ MySQL è‡ªå®šä¹‰å®ç° | å†…å­˜æ•°æ®ä¸æŒä¹… |

#### 2.2 æŠ€æœ¯æ ˆå…¼å®¹æ€§çŸ©é˜µ

| æ ¸å¿ƒç»„ä»¶ | æ¨èç‰ˆæœ¬ | å…¼å®¹æ€§è¦æ±‚/ä¾èµ– | è¯´æ˜ |
| :--- | :--- | :--- | :--- |
| **Python** | 3.11+ | >= 3.10 | LangChain 1.2.5 æœ€ä½è¦æ±‚ |
| **langchain** | 1.2.5 | éœ€é…åˆ langchain-core 0.3.x | Agentæ ¸å¿ƒæ¡†æ¶ |
| **langchain-community** | 0.3.x | ä¸ langchain 1.2.5 å¯¹é½ | FAISS VectorStore é›†æˆ |
| **faiss-cpu** | 1.8.x | éœ€ numpy >= 1.24 | å‘é‡æ£€ç´¢å¼•æ“ |
| **FastAPI** | 0.115.x | éœ€ uvicorn 0.30+, pydantic v2 | åç«¯APIæ¡†æ¶ |
| **React** | 18.x | éœ€ Node.js >= 18 | å‰ç«¯æ¡†æ¶ |
| **Tailwind CSS** | 3.4.x | éœ€ PostCSS 8.x | åŸå­åŒ–CSSæ¡†æ¶ |
| **MySQL** | 8.0+ | éœ€ pymysql æˆ– aiomysql | æŒä¹…åŒ–å­˜å‚¨ |
| **Zustand** | 4.x | React 18+ | å‰ç«¯çŠ¶æ€ç®¡ç† |

#### 2.3 é€‰å‹æ‹“æ‰‘å›¾

```mermaid
graph LR
    subgraph å‰ç«¯
        React[React 18] --> TailwindCSS[Tailwind CSS 3.4]
        React --> Zustand[Zustand 4.x]
        React --> SSEClient[EventSource API]
    end

    subgraph åç«¯
        FastAPI[FastAPI 0.115] --> LangChain[LangChain 1.2.5]
        LangChain --> LangChainCore[langchain-core 0.3.x]
        LangChain --> LangChainCommunity[langchain-community 0.3.x]
        LangChainCommunity --> FAISS[faiss-cpu 1.8.x]
        FastAPI --> MySQL[MySQL 8.0]
    end

    SSEClient -. SSE .-> FastAPI
    FAISS -. BLOBå­˜å‚¨ .-> MySQL
```

---

### 3. ç³»ç»Ÿæ¶æ„è®¾è®¡

#### 3.1 åˆ†å±‚æ¶æ„è§†å›¾

```mermaid
graph TD
    subgraph æ¥å…¥å±‚
        UI[React å‰ç«¯å·¥ä½œå°] --> SSE[SSE EventSource]
        UI --> REST[REST API]
    end

    subgraph APIç½‘å…³å±‚
        SSE --> FastAPI[FastAPI Server]
        REST --> FastAPI
        FastAPI --> Auth[é‰´æƒä¸­é—´ä»¶]
    end

    subgraph ä¸šåŠ¡é€»è¾‘å±‚
        Auth --> AgentCore[Agent ä¸»å…¥å£]
        AgentCore --> Middleware[Middleware Pipeline]
        Middleware --> HITL[HumanInTheLoopMiddleware]
        Middleware --> SubAgentMW[SubAgentMiddleware]
        SubAgentMW --> TodoTracker[todo_tracker å“åº”å¼å­Agent]
        AgentCore --> ToolRegistry[Tool æ³¨å†Œä¸­å¿ƒ]
        AgentCore --> KnowledgeRetriever[é¢†åŸŸçŸ¥è¯†æ£€ç´¢å™¨]
    end

    subgraph æ•°æ®å±‚
        ToolRegistry --> LegacyAPI[å­˜é‡ç³»ç»Ÿ API]
        KnowledgeRetriever --> FAISSIndex[FAISS å‘é‡ç´¢å¼•]
        FAISSIndex --> MySQL[(MySQL)]
        AgentCore --> Checkpointer[InMemorySaver / MySQL Saver]
    end
```

#### 3.2 ç»„ä»¶äº¤äº’è§†å›¾

```mermaid
graph LR
    User((ç”¨æˆ·)) --> Frontend[React å·¥ä½œå°]
    Frontend --> |REST/SSE| Backend[FastAPI]
    Backend --> MainAgent[ä¸»Agent]
    MainAgent --> |middleware| HITLMiddleware[HITLä¸­é—´ä»¶]
    MainAgent --> |middleware| SubAgentMW[SubAgentMiddleware]
    SubAgentMW --> |reactive| TodoTracker[todo_tracker]
    SubAgentMW --> |delegated| SubAgent[å§”æ´¾å­Agent]
    MainAgent --> |tool call| ToolRegistry[Toolæ³¨å†Œä¸­å¿ƒ]
    MainAgent --> |retrieval| FAISSRetriever[FAISSæ£€ç´¢å™¨]
    SubAgent --> |tool call| ToolRegistry
    ToolRegistry --> LegacySystem[å­˜é‡ç³»ç»Ÿ]
    FAISSRetriever --> VectorStore[(FAISS Index)]
    VectorStore --> MySQL[(MySQL BLOB)]
```

---

### 4. æ ¸å¿ƒä¸šåŠ¡æµ

#### 4.1 ä¸»æµç¨‹ï¼šç”¨æˆ·è¾“å…¥ â†’ Agentæ‰§è¡Œ â†’ æµå¼è¾“å‡º

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·/å‰ç«¯
    participant API as FastAPI
    participant Agent as ä¸»Agent
    participant MW as Middleware Pipeline
    participant LLM as LLM
    participant FAISS as FAISSæ£€ç´¢
    participant Tool as Tool/SubAgent
    participant SSE as SSE Stream

    U->>API: POST /api/chat (ç”¨æˆ·è¾“å…¥)
    API->>Agent: agent.stream({messages})
    Agent->>MW: TodoMiddleware.before_model()
    MW-->>SSE: todo.state äº‹ä»¶ (åˆå§‹åŒ–TODO)
    Agent->>LLM: å‘é€æ¶ˆæ¯ + Toolæè¿°
    LLM-->>SSE: thinking äº‹ä»¶ (Tokenæµ)

    alt è¯†åˆ«åˆ°ä¸“ä¸šæœ¯è¯­
        Agent->>FAISS: é¢†åŸŸçŸ¥è¯†æ£€ç´¢
        FAISS-->>Agent: è¿”å›ç›¸å…³æ–‡æ¡£ç‰‡æ®µ
        Agent->>LLM: è¡¥å……é¢†åŸŸçŸ¥è¯†ä¸Šä¸‹æ–‡
    end

    LLM-->>Agent: é€‰æ‹©Tool + å‚æ•°
    SSE-->>U: tool.call äº‹ä»¶ (Toolåç§°+å‚æ•°)

    alt HumanInTheLoopè§¦å‘
        MW->>U: é˜»å¡ç­‰å¾…ç”¨æˆ·ç¡®è®¤
        U-->>MW: approve / edit / reject
        alt reject
            MW-->>Agent: ä»»åŠ¡ç»ˆæ­¢
            SSE-->>U: error äº‹ä»¶
        end
    end

    Agent->>Tool: æ‰§è¡ŒToolè°ƒç”¨
    Tool-->>Agent: è¿”å›ç»“æœ
    SSE-->>U: tool.result äº‹ä»¶
    MW-->>SSE: todo.state äº‹ä»¶ (æ›´æ–°æ­¥éª¤çŠ¶æ€)

    Agent->>LLM: å¤„ç†Toolç»“æœ
    LLM-->>SSE: thinking äº‹ä»¶
    LLM-->>Agent: æœ€ç»ˆå›å¤
    SSE-->>U: message äº‹ä»¶ (å®Œæ•´å›å¤)
```

#### 4.2 Human-in-the-Loop äº¤äº’æµç¨‹

```mermaid
sequenceDiagram
    participant Agent as ä¸»Agent
    participant HITL as HumanInTheLoopMiddleware
    participant SSE as SSE Stream
    participant U as ç”¨æˆ·/å‰ç«¯

    Agent->>HITL: Toolè°ƒç”¨å‰æ‹¦æˆª
    HITL->>SSE: hitl.pending äº‹ä»¶ (Toolå+å‚æ•°+schema)
    SSE->>U: å±•ç¤ºé…ç½®å¡ç‰‡ (å¯ç¼–è¾‘å‚æ•°)

    alt approve
        U->>SSE: hitl.approve (åŸå§‹å‚æ•°)
        SSE->>HITL: ç»§ç»­æ‰§è¡Œ
        HITL->>Agent: æ”¾è¡ŒToolè°ƒç”¨
    else edit
        U->>SSE: hitl.edit (ä¿®æ”¹åå‚æ•°)
        SSE->>HITL: ä½¿ç”¨æ–°å‚æ•°
        HITL->>Agent: ä»¥ä¿®æ”¹å‚æ•°æ‰§è¡ŒTool
    else reject
        U->>SSE: hitl.reject
        SSE->>HITL: ç»ˆæ­¢
        HITL->>Agent: æŠ›å‡ºå¼‚å¸¸ï¼Œä»»åŠ¡å¤±è´¥
    end
```

#### 4.3 TODOçŠ¶æ€ç®¡ç†æµç¨‹

```mermaid
stateDiagram-v2
    [*] --> pending: åˆå§‹åŒ–
    pending --> in_progress: Agentå¼€å§‹æ‰§è¡Œè¯¥æ­¥éª¤
    in_progress --> completed: æ­¥éª¤æ‰§è¡ŒæˆåŠŸ
    in_progress --> failed: æ­¥éª¤æ‰§è¡Œå¤±è´¥
    failed --> [*]: æ•´ä¸ªä»»åŠ¡ç»ˆæ­¢
    completed --> [*]: æ‰€æœ‰æ­¥éª¤å®Œæˆ
    in_progress --> replan: LLMå†³å®šè°ƒæ•´è®¡åˆ’
    replan --> pending: é‡æ–°è§„åˆ’æ­¥éª¤
```

---

### 5. æ•°æ®æ¨¡å‹è®¾è®¡

#### 5.1 æ ¸å¿ƒå®ä½“å…³ç³»å›¾

```mermaid
erDiagram
    CONVERSATION ||--o{ MESSAGE : contains
    CONVERSATION ||--o{ TASK : triggers
    TASK ||--o{ TODO_STEP : decomposes
    TASK ||--o{ TOOL_EXECUTION : records
    TODO_STEP ||--o| TOOL_EXECUTION : maps_to
    KNOWLEDGE_BASE ||--o{ KNOWLEDGE_DOCUMENT : stores
    KNOWLEDGE_BASE ||--|| FAISS_INDEX : indexes
    TOOL_DEFINITION ||--o{ TOOL_EXECUTION : instances

    CONVERSATION {
        string id PK
        string session_id
        datetime created_at
        datetime updated_at
    }

    MESSAGE {
        string id PK
        string conversation_id FK
        string role "user/assistant/tool"
        text content
        json tool_calls "nullable"
        datetime created_at
    }

    TASK {
        string id PK
        string conversation_id FK
        string status "pending/in_progress/completed/failed"
        text description
        datetime created_at
        datetime updated_at
    }

    TODO_STEP {
        string id PK
        string task_id FK
        int order_index
        string status "pending/in_progress/completed/failed/replan"
        text description
        text result "nullable"
        datetime created_at
        datetime updated_at
    }

    TOOL_EXECUTION {
        string id PK
        string task_id FK
        string todo_step_id FK "nullable"
        string tool_name
        json input_params
        json output_result "nullable"
        string hitl_status "auto/approved/edited/rejected"
        json hitl_edited_params "nullable"
        string status "pending/running/success/failed"
        datetime created_at
        datetime completed_at "nullable"
    }

    TOOL_DEFINITION {
        string name PK
        text description
        json parameters_schema
        string category "è€—æ—¶/å¤æ‚/å¤–éƒ¨è°ƒç”¨"
        boolean requires_hitl
        json dependencies "ä¾èµ–çš„å…¶ä»–Toolåç§°åˆ—è¡¨"
    }

    KNOWLEDGE_BASE {
        string id PK
        string name "æœ¯è¯­è¡¨/è®¾è®¡æ–‡æ¡£"
        string type "terminology/design_doc"
        datetime last_updated
    }

    KNOWLEDGE_DOCUMENT {
        string id PK
        string knowledge_base_id FK
        string file_path
        text content
        string content_hash "å¢é‡æ›´æ–°æ ¡éªŒ"
        datetime created_at
    }

    FAISS_INDEX {
        string id PK
        string knowledge_base_id FK
        blob index_data "FAISSåºåˆ—åŒ–äºŒè¿›åˆ¶"
        int dimension
        int doc_count
        datetime created_at
    }
```

#### 5.2 æ ¸å¿ƒæ•°æ®åº“è¡¨è®¾è®¡

| è¡¨å | å­—æ®µ | ç±»å‹ | è¯´æ˜ |
| :--- | :--- | :--- | :--- |
| **conversations** | id | VARCHAR(36) PK | UUID |
| | session_id | VARCHAR(36) | ç”¨æˆ·ä¼šè¯æ ‡è¯† |
| | created_at | DATETIME | åˆ›å»ºæ—¶é—´ |
| **messages** | id | VARCHAR(36) PK | UUID |
| | conversation_id | VARCHAR(36) FK | å…³è”ä¼šè¯ |
| | role | ENUM('user','assistant','tool') | æ¶ˆæ¯è§’è‰² |
| | content | TEXT | æ¶ˆæ¯å†…å®¹ |
| | tool_calls | JSON | Toolè°ƒç”¨ä¿¡æ¯ï¼ˆnullableï¼‰ |
| **tasks** | id | VARCHAR(36) PK | UUID |
| | conversation_id | VARCHAR(36) FK | å…³è”ä¼šè¯ |
| | status | ENUM('pending','in_progress','completed','failed') | ä»»åŠ¡çŠ¶æ€ |
| | description | TEXT | ä»»åŠ¡æè¿° |
| **todo_steps** | id | VARCHAR(36) PK | UUID |
| | task_id | VARCHAR(36) FK | å…³è”ä»»åŠ¡ |
| | order_index | INT | æ­¥éª¤åºå· |
| | status | ENUM('pending','in_progress','completed','failed','replan') | æ­¥éª¤çŠ¶æ€ |
| | description | TEXT | æ­¥éª¤æè¿° |
| | result | TEXT | æ‰§è¡Œç»“æœï¼ˆnullableï¼‰ |
| **tool_executions** | id | VARCHAR(36) PK | UUID |
| | task_id | VARCHAR(36) FK | å…³è”ä»»åŠ¡ |
| | tool_name | VARCHAR(128) | Toolåç§° |
| | input_params | JSON | è¾“å…¥å‚æ•° |
| | output_result | JSON | è¾“å‡ºç»“æœï¼ˆnullableï¼‰ |
| | hitl_status | ENUM('auto','approved','edited','rejected') | HITLå†³ç­– |
| | status | ENUM('pending','running','success','failed') | æ‰§è¡ŒçŠ¶æ€ |
| **faiss_indexes** | id | VARCHAR(36) PK | UUID |
| | knowledge_base_id | VARCHAR(36) FK | å…³è”çŸ¥è¯†åº“ |
| | index_data | LONGBLOB | FAISSåºåˆ—åŒ–ç´¢å¼• |
| | dimension | INT | å‘é‡ç»´åº¦ |
| | doc_count | INT | æ–‡æ¡£æ•°é‡ |

---

### 6. API æ¥å£è®¾è®¡

#### 6.1 æ¥å£çŸ©é˜µ

| Method | Path | è¯´æ˜ | è¯·æ±‚ä½“ | å“åº” |
| :--- | :--- | :--- | :--- | :--- |
| POST | `/api/chat` | å‘èµ·å¯¹è¯ï¼ˆSSEæµå¼ï¼‰ | `ChatRequest` | SSE EventStream |
| POST | `/api/hitl/{execution_id}/decide` | HITLå†³ç­–æäº¤ | `HITLDecision` | `200 OK` |
| GET | `/api/conversations` | è·å–ä¼šè¯åˆ—è¡¨ | - | `Conversation[]` |
| GET | `/api/conversations/{id}` | è·å–ä¼šè¯è¯¦æƒ…åŠæ¶ˆæ¯ | - | `ConversationDetail` |
| GET | `/api/tasks/{task_id}/todos` | è·å–TODOæ­¥éª¤åˆ—è¡¨ | - | `TodoStep[]` |
| POST | `/api/knowledge/rebuild` | è§¦å‘çŸ¥è¯†åº“é‡å»º | `RebuildRequest` | `202 Accepted` |
| GET | `/api/tools` | è·å–å·²æ³¨å†ŒToolåˆ—è¡¨ | - | `ToolDefinition[]` |

#### 6.2 API äº¤äº’æ—¶åºå›¾

```mermaid
sequenceDiagram
    participant FE as React å‰ç«¯
    participant API as FastAPI
    participant Agent as Agent Core

    FE->>API: POST /api/chat {message, conversation_id}
    API->>Agent: agent.stream(...)
    loop SSE Events
        Agent-->>API: yield event
        API-->>FE: SSE: event_type + data
    end

    Note over FE: æ”¶åˆ° hitl.pending äº‹ä»¶

    FE->>FE: å±•ç¤ºé…ç½®å¡ç‰‡, ç”¨æˆ·æ“ä½œ
    FE->>API: POST /api/hitl/{id}/decide {action, params}
    API->>Agent: resolve HITL interrupt
    Agent-->>API: ç»§ç»­æ‰§è¡Œ
    API-->>FE: SSE: tool.result
```

#### 6.3 æ¥å£å¥‘çº¦

**POST /api/chat - è¯·æ±‚ä½“**
```json
{
  "conversation_id": "string | null",
  "message": "string"
}
```

**SSE Event æ ¼å¼**
```
event: {event_type}
data: {json_payload}

```

| event_type | data ç»“æ„ | è¯´æ˜ |
| :--- | :--- | :--- |
| `thinking` | `{"token": "string"}` | LLM Tokenæµå¼è¾“å‡º |
| `tool.call` | `{"tool_name": "string", "params": {}, "execution_id": "string"}` | Toolè°ƒç”¨å¼€å§‹ |
| `tool.result` | `{"execution_id": "string", "result": {}, "status": "success/failed"}` | Toolè°ƒç”¨ç»“æœ |
| `hitl.pending` | `{"execution_id": "string", "tool_name": "string", "params": {}, "schema": {}}` | ç­‰å¾…HITLå†³ç­– |
| `todo.state` | `{"task_id": "string", "steps": [{"id","description","status"}]}` | TODOçŠ¶æ€æ›´æ–° |
| `message` | `{"content": "string"}` | æœ€ç»ˆå›å¤ |
| `error` | `{"code": "string", "message": "string"}` | é”™è¯¯ä¿¡æ¯ |

**POST /api/hitl/{execution_id}/decide - è¯·æ±‚ä½“**
```json
{
  "action": "approve | edit | reject",
  "edited_params": {}
}
```

**çŠ¶æ€ç å®šä¹‰**

| çŠ¶æ€ç  | è¯´æ˜ |
| :--- | :--- |
| 200 | æˆåŠŸ |
| 202 | å·²æ¥å—ï¼ˆå¼‚æ­¥å¤„ç†ï¼‰ |
| 400 | è¯·æ±‚å‚æ•°é”™è¯¯ |
| 401 | æœªæˆæƒ |
| 404 | èµ„æºä¸å­˜åœ¨ |
| 500 | æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ |

---

### 7. å‰ç«¯æ¶æ„è®¾è®¡

#### 7.1 æŠ€æœ¯æ ˆ

- **æ¡†æ¶**ï¼šReact 18 + TypeScript
- **æ ·å¼**ï¼šTailwind CSS 3.4ï¼ˆéµå¾ªUCDè®¾è®¡è§„èŒƒï¼‰
- **çŠ¶æ€ç®¡ç†**ï¼šZustand 4.x
- **é€šä¿¡**ï¼šEventSource API (SSE) + Fetch API (REST)
- **æ„å»ºå·¥å…·**ï¼šVite

#### 7.2 è®¾è®¡ç³»ç»Ÿ Tokenï¼ˆåŸºäºUCDè®¾è®¡.mdï¼‰

```typescript
// design-tokens.ts
export const colors = {
  primary:    '#A78BFA', // è–°è¡£è‰ç´« - äº¤äº’é«˜äº®ã€ç¡®è®¤æŒ‰é’®
  secondary:  '#60A5FA', // å¤©ç©ºè“   - è¿è¡Œä¸­çŠ¶æ€
  success:    '#34D399', // è–„è·ç»¿   - å®ŒæˆçŠ¶æ€
  error:      '#F87171', // çŠç‘šçº¢   - å¤±è´¥çŠ¶æ€
  background: '#FAFAFA', // é¡µé¢èƒŒæ™¯
  card:       '#FFFFFF', // ç»„ä»¶å¡ç‰‡
  textPrimary:   '#1F2937', // ä¸»æ–‡å­—
  textSecondary: '#6B7280', // æ¬¡æ–‡å­—
  textWeak:      '#9CA3AF', // å¼±æ–‡å­—
} as const;

export const spacing = {
  grid: 8,     // 8px åŸºå‡†ç½‘æ ¼
  gutter: 24,  // æ …æ ¼é—´è·
  columns: 12, // 12æ ç½‘æ ¼
} as const;

export const typography = {
  fontFamily: "'Inter', -apple-system, sans-serif",
} as const;
```

#### 7.3 ç»„ä»¶æ¶æ„æ‹†è§£

```mermaid
graph TD
    App[App] --> Layout[WorkstationLayout ä¸‰æ å¸ƒå±€]
    Layout --> Sidebar[ConversationSidebar å·¦ä¾§è¾¹æ ]
    Layout --> ChatArea[ChatArea ä¸­é—´èŠå¤©åŒº]
    Layout --> TaskPanel[TaskPanel å³ä¾§ä»»åŠ¡é¢æ¿]

    Sidebar --> ConvList[ConversationList]
    Sidebar --> ConvItem[ConversationItem]

    ChatArea --> MessageList[MessageList]
    ChatArea --> MessageBubble[MessageBubble]
    ChatArea --> InputBar[ChatInputBar]
    MessageBubble --> TodoStepper[TodoStepper åµŒå…¥å¼TODO]
    MessageBubble --> ToolCallCard[ToolCallCard Toolè°ƒç”¨å¡ç‰‡]
    MessageBubble --> ThinkingIndicator[ThinkingIndicator æ€è€ƒä¸­]

    TodoStepper --> StepItem[StepItem æ­¥éª¤é¡¹]
    StepItem --> StatusIcon[StatusIcon çŠ¶æ€å›¾æ ‡]
    StepItem --> ProgressBar[ProgressBar è¿›åº¦æ¡]

    ToolCallCard --> HITLModal[HITLConfigModal é…ç½®å¼¹çª—]
    HITLModal --> DynamicForm[DynamicForm åŠ¨æ€è¡¨å•]
    HITLModal --> ActionButtons[ActionButtons approve/edit/reject]

    TaskPanel --> TaskList[TaskList]
    TaskPanel --> TaskCard[TaskCard ä»»åŠ¡å¡ç‰‡]
    TaskCard --> TaskProgress[TaskProgressBar]
    TaskCard --> TaskStatus[TaskStatusBadge]
```

#### 7.4 Zustand Store è®¾è®¡

```typescript
// stores/chatStore.ts
interface ChatStore {
  // ä¼šè¯ç®¡ç†
  conversations: Conversation[];
  activeConversationId: string | null;

  // æ¶ˆæ¯
  messages: Message[];

  // TODOçŠ¶æ€
  todoSteps: Record<string, TodoStep[]>; // taskId -> steps

  // HITL
  pendingHITL: HITLPending | null;

  // SSEè¿æ¥
  sseConnection: EventSource | null;

  // Actions
  sendMessage: (content: string) => void;
  handleSSEEvent: (event: SSEEvent) => void;
  submitHITLDecision: (executionId: string, decision: HITLDecision) => void;
}
```

#### 7.5 ä¸‰æ å¸ƒå±€ç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WINS Agent å·¥ä½œå°                              [ç”¨æˆ·å¤´åƒ] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚            â”‚                          â”‚                  â”‚
â”‚  å¯¹è¯å†å²    â”‚   èŠå¤©åŒºåŸŸ                â”‚   ä»»åŠ¡è¿›åº¦é¢æ¿    â”‚
â”‚            â”‚                          â”‚                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ä¼šè¯1 â”‚  â”‚  â”‚ AI: æˆ‘å·²åˆ†ææ‚¨çš„éœ€æ±‚  â”‚ â”‚  â”‚ ä»»åŠ¡#1      â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”¤  â”‚  â”‚                     â”‚ â”‚  â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ 4/6  â”‚ â”‚
â”‚  â”‚ ä¼šè¯2 â”‚  â”‚  â”‚ â”Œâ”€ TODO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”¤  â”‚  â”‚ â”‚ âœ“ æ­¥éª¤1 å·²å®Œæˆ   â”‚â”‚ â”‚  â”‚ ä»»åŠ¡#2      â”‚ â”‚
â”‚  â”‚ ä¼šè¯3 â”‚  â”‚  â”‚ â”‚ â— æ­¥éª¤2 æ‰§è¡Œä¸­   â”‚â”‚ â”‚  â”‚ â–ˆâ–ˆâ–‘â–‘â–‘â–‘ 2/6  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚ â”‚ â—‹ æ­¥éª¤3 å¾…æ‰§è¡Œ   â”‚â”‚ â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚            â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â”‚                  â”‚
â”‚            â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                  â”‚
â”‚            â”‚                          â”‚                  â”‚
â”‚            â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                  â”‚
â”‚            â”‚  â”‚ [é…ç½®å¡ç‰‡ - HITL]    â”‚ â”‚                  â”‚
â”‚            â”‚  â”‚  å‚æ•°1: [____]      â”‚ â”‚                  â”‚
â”‚            â”‚  â”‚  å‚æ•°2: [â–¼ ä¸‹æ‹‰]    â”‚ â”‚                  â”‚
â”‚            â”‚  â”‚ [Approve] [Reject]  â”‚ â”‚                  â”‚
â”‚            â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                  â”‚
â”‚            â”‚                          â”‚                  â”‚
â”‚            â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                  â”‚
â”‚            â”‚  â”‚ ğŸ“  è¾“å…¥æ¶ˆæ¯...      â”‚ â”‚                  â”‚
â”‚            â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Â© WINS Agent                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 8. å…³é”®ç‰¹æ€§è®¾è®¡

#### 8.1 é¢†åŸŸçŸ¥è¯†ç®¡ç†æ¨¡å—

**æ¶æ„**ï¼šåŒåº“åˆ†ç¦»ï¼ˆæœ¯è¯­è¡¨åº“ + è®¾è®¡æ–‡æ¡£åº“ï¼‰ï¼Œå„è‡ªç‹¬ç«‹ FAISS Indexã€‚

```mermaid
graph LR
    subgraph çŸ¥è¯†ç®¡ç†
        MD1[æœ¯è¯­è¡¨ .md] --> Splitter1[æ–‡æœ¬åˆ†å‰²å™¨]
        MD2[è®¾è®¡æ–‡æ¡£ .md] --> Splitter2[æ–‡æœ¬åˆ†å‰²å™¨]
        Splitter1 --> Embed1[Embeddingæ¨¡å‹]
        Splitter2 --> Embed2[Embeddingæ¨¡å‹]
        Embed1 --> FAISS1[(æœ¯è¯­è¡¨ FAISS Index)]
        Embed2 --> FAISS2[(è®¾è®¡æ–‡æ¡£ FAISS Index)]
        FAISS1 --> MySQL1[(MySQL BLOB)]
        FAISS2 --> MySQL2[(MySQL BLOB)]
    end
```

**æ£€ç´¢è§¦å‘æœºåˆ¶**ï¼š

```python
# æ–¹å¼ï¼šä½œä¸ºAgentçš„Retrieval Toolï¼Œç”±LLMè‡ªä¸»å†³å®šä½•æ—¶è°ƒç”¨
@tool(response_format="content_and_artifact")
def search_terminology(query: str):
    """å½“é‡åˆ°ä¸“ä¸šæœ¯è¯­æˆ–éœ€è¦æŸ¥è¯¢æœ¯è¯­å®šä¹‰æ—¶ï¼Œä½¿ç”¨æ­¤å·¥å…·æ£€ç´¢ä¸“ä¸šæœ¯è¯­è¡¨ã€‚"""
    docs = terminology_vector_store.similarity_search(query, k=3)
    serialized = "\n\n".join(
        f"æœ¯è¯­: {doc.metadata.get('term', 'N/A')}\nå®šä¹‰: {doc.page_content}"
        for doc in docs
    )
    return serialized, docs

@tool(response_format="content_and_artifact")
def search_design_doc(query: str):
    """å½“éœ€è¦äº†è§£å­˜é‡ç³»ç»Ÿè®¾è®¡æˆ–æ¥å£è§„èŒƒæ—¶ï¼Œä½¿ç”¨æ­¤å·¥å…·æ£€ç´¢ç³»ç»Ÿè®¾è®¡æ–‡æ¡£ã€‚"""
    docs = design_doc_vector_store.similarity_search(query, k=3)
    serialized = "\n\n".join(
        f"æ¥æº: {doc.metadata.get('source', 'N/A')}\nå†…å®¹: {doc.page_content}"
        for doc in docs
    )
    return serialized, docs
```

**å¢é‡æ›´æ–°ç­–ç•¥**ï¼š
1. è®¡ç®—æ–‡æ¡£ content_hashï¼ˆMD5ï¼‰ï¼Œä¸æ•°æ®åº“ä¸­å·²å­˜è®°å½•å¯¹æ¯”
2. ä»…å¯¹æ–°å¢/å˜æ›´çš„æ–‡æ¡£é‡æ–°ç”Ÿæˆ Embedding å¹¶è¿½åŠ åˆ° FAISS Index
3. æ›´æ–°åçš„ FAISS Index åºåˆ—åŒ–ä¸ºäºŒè¿›åˆ¶å­˜å…¥ MySQL BLOB å­—æ®µ
4. æ›´æ–°é¢‘ç‡ç”±å®šæ—¶ä»»åŠ¡æ§åˆ¶ï¼ˆå…·ä½“é—´éš” TBDï¼‰

#### 8.2 Toolç¼–æ’ä¸æ³¨å†Œä¸­å¿ƒ

**è®¾è®¡åŸåˆ™**ï¼š
- æ¯ä¸ªToolä½¿ç”¨ `@tool` è£…é¥°å™¨å°è£…ï¼Œdescriptionä¸­å£°æ˜ä¾èµ–å…³ç³»
- LLMé€šè¿‡descriptionç†è§£ä¾èµ–å¹¶æŒ‰åºè°ƒç”¨ï¼ˆä¸æ”¯æŒå¹¶è¡Œè°ƒç”¨ï¼‰
- æ”¯æŒé™æ€ä¾èµ–ï¼ˆdescriptionä¸­å£°æ˜ï¼‰+ åŠ¨æ€æ¨æ–­ï¼ˆLLMæ ¹æ®ä¸Šä¸‹æ–‡åˆ¤æ–­ï¼‰

```python
from langchain.tools import tool

@tool
def create_order(
    customer_id: str,
    product_codes: list[str],
    quantities: list[int],
    delivery_address: str
):
    """åˆ›å»ºè®¢å•ã€‚ä¾èµ–å…³ç³»ï¼šè°ƒç”¨å‰éœ€å…ˆé€šè¿‡ validate_customer éªŒè¯å®¢æˆ·æœ‰æ•ˆæ€§ï¼Œ
    å¹¶é€šè¿‡ check_inventory ç¡®è®¤åº“å­˜å……è¶³ã€‚

    å‚æ•°è¯´æ˜ï¼š
    - customer_id: å®¢æˆ·ç¼–ç ï¼ˆå¯é€šè¿‡ search_customer å·¥å…·æŸ¥è¯¢ï¼‰
    - product_codes: äº§å“ç¼–ç åˆ—è¡¨ï¼ˆéœ€ç¬¦åˆERPç¼–ç è§„èŒƒï¼‰
    - quantities: å¯¹åº”äº§å“çš„æ•°é‡åˆ—è¡¨
    - delivery_address: é…é€åœ°å€ï¼ˆéœ€åŒ…å«çœå¸‚åŒºï¼‰
    """
    # è°ƒç”¨å­˜é‡ç³»ç»ŸAPI
    return legacy_api.create_order(...)
```

**Toolæ³¨å†Œä¸­å¿ƒç±»å›¾**ï¼š

```mermaid
classDiagram
    class ToolRegistry {
        -tools: Dict[str, StructuredTool]
        -categories: Dict[str, List[str]]
        +register(tool: StructuredTool, category: str)
        +get_all_tools() List[StructuredTool]
        +get_tools_by_category(category: str) List[StructuredTool]
        +get_tool_schema(name: str) Dict
    }

    class ToolCategory {
        <<enumeration>>
        QUERY: æŸ¥è¯¢ç±»
        MUTATION: å˜æ›´ç±»
        LONG_RUNNING: è€—æ—¶ç±»
        EXTERNAL: å¤–éƒ¨è°ƒç”¨ç±»
    }

    class ToolWrapper {
        +name: str
        +description: str
        +parameters_schema: Dict
        +requires_hitl: bool
        +dependencies: List[str]
        +invoke(params: Dict) Any
    }

    ToolRegistry "1" --> "*" ToolWrapper : manages
    ToolWrapper --> ToolCategory : categorized_by
```

#### 8.3 Agent-as-Toolï¼ˆSubAgentæ¨¡å¼ï¼‰

> **âš  å·²æ¼”è¿›**ï¼šæœ¬èŠ‚æè¿°çš„æ‰‹å·¥ `@tool` åŒ…è£…æ¨¡å¼å·²è¢« **8.7 ç»Ÿä¸€ SubAgent æ‰©å±•æ¡†æ¶** å–ä»£ã€‚æ¡†æ¶é€šè¿‡ `SubAgentMiddleware` è‡ªåŠ¨æ„å»º `task()` toolï¼Œå®ç°å§”æ´¾å¼å­ Agent çš„ç»Ÿä¸€ç®¡ç†ã€‚ä¿ç•™æœ¬èŠ‚ä¾›æ¶æ„å¯¹æ¯”å‚è€ƒã€‚

åŸºäº LangChain 1.2.5 çš„ Agent-as-Tool æ¨¡å¼ï¼ŒSubAgent ä½œä¸ºä¸»Agent çš„ Tool è¢«è°ƒç”¨ï¼š

```python
from langchain.agents import create_agent
from langchain.tools import tool

# åˆ›å»ºä¸“ä¸šåŒ–SubAgent
data_analysis_agent = create_agent(
    model="...",
    tools=[query_database, generate_chart, export_csv],
    prompt="ä½ æ˜¯æ•°æ®åˆ†æä¸“å®¶ï¼Œè´Ÿè´£æ‰§è¡Œæ•°æ®æŸ¥è¯¢ã€åˆ†æå’Œå¯è§†åŒ–ä»»åŠ¡ã€‚"
)

# åŒ…è£…ä¸ºä¸»Agentçš„Tool
@tool("data_analysis", description="æ‰§è¡Œæ•°æ®åˆ†æä»»åŠ¡ï¼ŒåŒ…æ‹¬æ•°æ®æŸ¥è¯¢ã€ç»Ÿè®¡åˆ†æå’Œå›¾è¡¨ç”Ÿæˆã€‚é€‚ç”¨äºéœ€è¦å¤šæ­¥æ•°æ®å¤„ç†çš„å¤æ‚åˆ†æè¯·æ±‚ã€‚")
def call_data_analysis(query: str) -> str:
    """å°†å¤æ‚æ•°æ®åˆ†æä»»åŠ¡å§”æ´¾ç»™æ•°æ®åˆ†æä¸“å®¶SubAgentã€‚"""
    result = data_analysis_agent.invoke({
        "messages": [{"role": "user", "content": query}]
    })
    return result["messages"][-1].content

# ä¸»Agentæ³¨å†ŒSubAgent Tool
main_agent = create_agent(
    model="...",
    tools=[call_data_analysis, ...other_tools],
    middleware=[...],
    prompt="ä½ æ˜¯AI Agentå·¥ä½œå°çš„ä¸»è°ƒåº¦å™¨..."
)
```

**SubAgentåˆ†å‘å†³ç­–**ï¼šLLM æ ¹æ® Tool description è‡ªä¸»åˆ¤æ–­æ˜¯å¦éœ€è¦åˆ†å‘ç»™ SubAgentã€‚åˆ†å‘æ ‡å‡†å»ºè®®åœ¨ description ä¸­ä½“ç°ï¼š
- æ¶‰åŠå¤šæ­¥éª¤ä¸²è¡Œæ“ä½œ
- å±äºç‰¹å®šä¸“ä¸šé¢†åŸŸï¼ˆæ•°æ®åˆ†æã€æŠ¥è¡¨ç”Ÿæˆç­‰ï¼‰
- é¢„è®¡è€—æ—¶è¾ƒé•¿çš„å¤åˆä»»åŠ¡

#### 8.4 TodoListMiddleware è®¾è®¡

> **âš  å·²æ¼”è¿›**ï¼šåŸç”Ÿ `TodoListMiddleware` åœ¨å¤šè½®å¯¹è¯ä¸­å­˜åœ¨ TODO çŠ¶æ€åœæ­¢åˆ·æ–°çš„é—®é¢˜ã€‚å·²è¢« **8.7 ç»Ÿä¸€ SubAgent æ‰©å±•æ¡†æ¶** ä¸­çš„ `todo_tracker` å“åº”å¼å­ Agent å–ä»£ï¼Œé€šè¿‡ `after_model` hook è‡ªåŠ¨è§¦å‘ç‹¬ç«‹ LLM è°ƒç”¨æ¥è¿½è¸ªä»»åŠ¡è¿›åº¦ã€‚ä¿ç•™æœ¬èŠ‚ä¾›æ¶æ„å¯¹æ¯”å‚è€ƒã€‚

> **LangChain 1.2.5 åŸç”Ÿæä¾›** `TodoListMiddleware`ï¼ˆä½äº `langchain.agents.middleware.todo`ï¼‰ï¼Œæ— éœ€è‡ªå®šä¹‰å¼€å‘ã€‚

**å·¥ä½œæœºåˆ¶**ï¼š
1. ä¸­é—´ä»¶å‘Agentæ³¨å…¥ä¸€ä¸ª `write_todos` å·¥å…·ï¼ŒLLMé€šè¿‡è°ƒç”¨æ­¤å·¥å…·æ¥åˆ›å»º/æ›´æ–°TODOåˆ—è¡¨
2. TODOçŠ¶æ€å­˜å‚¨åœ¨ Agent State çš„ `todos` å­—æ®µä¸­ï¼ˆ`PlanningState`æ‰©å±•äº† `AgentState`ï¼‰
3. æ¯ä¸ªTODOé¡¹åŒ…å« `content`ï¼ˆå†…å®¹ï¼‰å’Œ `status`ï¼ˆpending/in_progress/completedï¼‰
4. ä¸­é—´ä»¶é€šè¿‡ `wrap_model_call` åœ¨ç³»ç»Ÿæç¤ºä¸­æ³¨å…¥TODOç®¡ç†æŒ‡ä»¤
5. `after_model` é’©å­ç¡®ä¿ `write_todos` ä¸è¢«å¹¶è¡Œè°ƒç”¨

```python
from langchain.agents.middleware.todo import TodoListMiddleware

# ç›´æ¥ä½¿ç”¨åŸç”Ÿä¸­é—´ä»¶
todo_middleware = TodoListMiddleware()

# å¯è‡ªå®šä¹‰ç³»ç»Ÿæç¤ºå’Œå·¥å…·æè¿°
custom_todo_middleware = TodoListMiddleware(
    system_prompt="è¯·ä¸ºå½“å‰ä»»åŠ¡åˆ¶å®šè¯¦ç»†çš„æ­¥éª¤è®¡åˆ’...",
    tool_description="åˆ›å»ºæˆ–æ›´æ–°å½“å‰ä»»åŠ¡çš„TODOæ­¥éª¤åˆ—è¡¨",
)
```

**State Schema æ‰©å±•**ï¼š
```python
from langchain.agents.middleware.todo import PlanningState, Todo

# PlanningState è‡ªåŠ¨æ‰©å±• AgentStateï¼Œæ·»åŠ  todos å­—æ®µ
# Todo TypedDict: {"content": str, "status": "pending" | "in_progress" | "completed"}
```

#### 8.5 HumanInTheLoopMiddleware é›†æˆ

ä½¿ç”¨ LangChain 1.2.5 åŸç”Ÿ `HumanInTheLoopMiddleware`ï¼š

```python
from langchain.agents import create_agent
from langchain.agents.middleware import HumanInTheLoopMiddleware
from langgraph.checkpoint.memory import InMemorySaver

# å®šä¹‰éœ€è¦HITLç¡®è®¤çš„Toolåˆ—è¡¨
hitl_tools = {
    "create_order": True,
    "update_customer": True,
    "delete_record": True,
    # ... æ•æ„Ÿæ“ä½œTool
}

agent = create_agent(
    llm,
    tools=tool_registry.get_all_tools(),
    prompt=system_prompt,
    middleware=[
        TodoListMiddleware(),  # è‡ªå®šä¹‰
        HumanInTheLoopMiddleware(
            interrupt_on=hitl_tools,
            description_prefix="è¯¥æ“ä½œéœ€è¦æ‚¨ç¡®è®¤",
        ),
    ],
    checkpointer=InMemorySaver(),
)
```

**å‰ç«¯HITLäº¤äº’**ï¼š
1. Agentæ‰§è¡Œåˆ°éœ€HITLçš„Toolæ—¶ï¼Œä¸­é—´ä»¶é˜»å¡å¹¶é€šè¿‡SSEæ¨é€ `hitl.pending` äº‹ä»¶
2. å‰ç«¯å±•ç¤ºåŠ¨æ€é…ç½®å¡ç‰‡ï¼ˆDynamicFormï¼‰ï¼Œè¡¨å•Schemaç”±Toolçš„ `parameters_schema` ç”Ÿæˆ
3. LLMæ¨æ–­çš„é»˜è®¤å€¼é¢„å¡«å…¥è¡¨å•
4. ç”¨æˆ·é€‰æ‹© approveï¼ˆç¡®è®¤ï¼‰/ editï¼ˆä¿®æ”¹å‚æ•°ï¼‰/ rejectï¼ˆæ‹’ç»ï¼‰
5. å‰ç«¯é€šè¿‡ `POST /api/hitl/{execution_id}/decide` æäº¤å†³ç­–
6. åç«¯ resolve HITL interruptï¼ŒAgentç»§ç»­æˆ–ç»ˆæ­¢

#### 8.6 SSE æµå¼è¾“å‡ºè®¾è®¡

```python
from fastapi import FastAPI
from fastapi.responses import StreamingResponse

app = FastAPI()

async def stream_agent_events(conversation_id: str, message: str):
    """ç”ŸæˆSSEäº‹ä»¶æµã€‚"""
    agent_stream = agent.stream(
        {"messages": [{"role": "user", "content": message}]},
        config={"configurable": {"thread_id": conversation_id}},
    )

    for event in agent_stream:
        # æ ¹æ®äº‹ä»¶ç±»å‹è½¬æ¢ä¸ºSSEæ ¼å¼
        if "messages" in event:
            msg = event["messages"][-1]
            if hasattr(msg, 'tool_calls') and msg.tool_calls:
                for tc in msg.tool_calls:
                    yield f"event: tool.call\ndata: {json.dumps({'tool_name': tc['name'], 'params': tc['args']})}\n\n"
            elif hasattr(msg, 'content') and msg.content:
                yield f"event: thinking\ndata: {json.dumps({'token': msg.content})}\n\n"

@app.post("/api/chat")
async def chat(request: ChatRequest):
    return StreamingResponse(
        stream_agent_events(request.conversation_id, request.message),
        media_type="text/event-stream",
        headers={
            "Cache-Control": "no-cache",
            "Connection": "keep-alive",
            "X-Accel-Buffering": "no",
        }
    )
```

#### 8.7 ç»Ÿä¸€ SubAgent æ‰©å±•æ¡†æ¶

> æ›¿ä»£ 8.3 Agent-as-Tool æ‰‹å·¥åŒ…è£… å’Œ 8.4 TodoListMiddleware åŸç”Ÿä¸­é—´ä»¶ï¼Œæä¾›ç»Ÿä¸€çš„å­ Agent æ³¨å†Œã€ç¼–è¯‘ã€è§¦å‘å’ŒçŠ¶æ€ç®¡ç†æœºåˆ¶ã€‚

##### 8.7.1 è®¾è®¡åŠ¨æœº

åŸç”Ÿ `TodoListMiddleware` åœ¨å¤šè½®å¯¹è¯ï¼ˆâ‰¥3è½®ï¼‰ä¸­å‡ºç° TODO çŠ¶æ€åœæ­¢åˆ·æ–°çš„é—®é¢˜ï¼Œæ ¹å› æ˜¯ `write_todos` å·¥å…·ä¸ä¸» LLM çš„å·¥å…·è°ƒç”¨äº§ç”Ÿç«äº‰ã€‚åŒæ—¶ï¼ŒAgent-as-Tool æ¨¡å¼éœ€è¦ä¸ºæ¯ä¸ª SubAgent æ‰‹å·¥ç¼–å†™ `@tool` åŒ…è£…å‡½æ•°ï¼Œç¼ºä¹ç»Ÿä¸€ç®¡ç†ã€‚

ç»Ÿä¸€ SubAgent æ‰©å±•æ¡†æ¶å‚è€ƒ deepagents `SubAgentMiddleware` æ¶æ„ï¼Œè§£å†³ä»¥ä¸‹é—®é¢˜ï¼š
- **TODO åˆ·æ–°ç¨³å®šæ€§**ï¼šå­ Agent ç‹¬ç«‹ LLM è°ƒç”¨ï¼Œä¸ä¾èµ–ä¸» LLM çš„å·¥å…·é€‰æ‹©
- **ç»Ÿä¸€ç®¡ç†**ï¼šå§”æ´¾å¼å’Œå“åº”å¼å­ Agent å…±ç”¨ä¸€å¥—æ³¨å†Œã€ç¼–è¯‘ã€è°ƒç”¨æœºåˆ¶
- **çŠ¶æ€éš”ç¦»**ï¼šå­ Agent ä»…æ¥æ”¶ç²¾ç®€ä¸Šä¸‹æ–‡ï¼Œä¸ä¼šæ±¡æŸ“ä¸» Agent å¯¹è¯å†å²
- **å¯æ‰©å±•æ€§**ï¼šæ–°å¢å­ Agent åªéœ€å®šä¹‰é…ç½®æ–‡ä»¶ï¼Œæ— éœ€ä¿®æ”¹æ¡†æ¶ä»£ç 

##### 8.7.2 æ¶æ„æ¦‚è§ˆ

```
ä¸» Agent (create_agent)
 â””â”€â”€ SubAgentMiddleware (ç»Ÿä¸€ Middleware)
      â”œâ”€â”€ delegated å­ Agent â†’ task() tool â†’ ä¸» LLM æ˜¾å¼å§”æ´¾
      â”‚    â””â”€â”€ çŠ¶æ€éš”ç¦»: messages è¿‡æ»¤, ä»…ä¼ å…¥ HumanMessage
      â”‚    â””â”€â”€ ç»“æœ: ToolMessage è¿”å›ä¸» Agent
      â””â”€â”€ reactive å­ Agent  â†’ after_model hook â†’ è‡ªåŠ¨è§¦å‘
           â””â”€â”€ çŠ¶æ€éš”ç¦»: context_builder æå–ç²¾ç®€ä¸Šä¸‹æ–‡
           â””â”€â”€ ç»“æœ: result_parser â†’ state[owned_key] â†’ SSE
```

**ä¸¤ç§è§¦å‘æ¨¡å¼ï¼š**

| | å§”æ´¾å¼ (Delegated) | å“åº”å¼ (Reactive) |
|---|---|---|
| è§¦å‘æ–¹å¼ | ä¸» LLM æ˜¾å¼è°ƒç”¨ `task()` tool | `after_model` hook è‡ªåŠ¨è§¦å‘ |
| ä¸Šä¸‹æ–‡ | ä»…ä¼ å…¥ `task_description` | `context_builder` æå–ç²¾ç®€ä¸Šä¸‹æ–‡ |
| ç»“æœå¤„ç† | è¿”å›æ–‡æœ¬ä½œä¸º ToolMessage | `result_parser` è§£æä¸º state æ›´æ–° |
| å…¸å‹åœºæ™¯ | æ•°æ®åˆ†æã€æŠ¥è¡¨ç”Ÿæˆ | TODO è¿½è¸ªã€è´¨é‡è¯„ä¼° |

**ä¸¤ç§æ‰§è¡Œæ¨¡å¼ï¼š**

| | Simple æ¨¡å¼ | Full Agent æ¨¡å¼ |
|---|---|---|
| é€‚ç”¨ | æ—  tools çš„å­ Agent | æœ‰ tools çš„å­ Agent |
| æ‰§è¡Œ | ç›´æ¥ `llm.invoke()` | `create_agent` + `agent.invoke()` |
| ç»“æœ | `result_parser(str)` è§£æ LLM æ–‡æœ¬ | ä»è¾“å‡º state æå– `owned_state_keys` |
| å…¸å‹åœºæ™¯ | TODO è·Ÿè¸ªå™¨ | æ•°æ®åˆ†æ Agent |

##### 8.7.3 æ–‡ä»¶ç»“æ„

```
backend/app/agent/subagents/
â”œâ”€â”€ __init__.py           # å…¬å…± API å¯¼å‡º
â”œâ”€â”€ types.py              # SubAgentConfig, ReactiveSubAgentConfig, CompiledSubAgent
â”œâ”€â”€ runner.py             # SubAgentRunner (ç¼–è¯‘ + è°ƒç”¨å¼•æ“)
â”œâ”€â”€ middleware.py          # SubAgentMiddleware (ç»Ÿä¸€ Middleware)
â””â”€â”€ agents/
    â”œâ”€â”€ __init__.py       # å­ Agent é…ç½®æ”¶é›†
    â””â”€â”€ todo_tracker.py   # TODO è·Ÿè¸ª reactive å­ Agent (é¦–ä¸ªæ¶ˆè´¹è€…)
```

##### 8.7.4 ç±»å‹ç³»ç»Ÿ (`types.py`)

```python
# Callable ç±»å‹åˆ«å
ContextBuilder = Callable[[dict[str, Any]], list[BaseMessage] | None]
# ä» parent state æå–ç²¾ç®€ä¸Šä¸‹æ–‡ï¼Œè¿”å› None è¡¨ç¤ºè·³è¿‡

ResultParser = Callable[[Any], dict[str, Any] | None]
# è§£æå­ Agent è¾“å‡ºä¸º state update dict

TriggerCondition = Callable[[dict[str, Any]], bool]
# åˆ¤æ–­æ˜¯å¦è§¦å‘ reactive å­ Agent

# å§”æ´¾å¼é…ç½®ï¼ˆä¸ deepagents SubAgent å¯¹é½ï¼‰
class SubAgentConfig(TypedDict):
    name: str                    # å”¯ä¸€æ ‡è¯†ç¬¦
    description: str             # åŠŸèƒ½æè¿°ï¼ˆç”¨ä½œ task() tool è¯´æ˜ï¼‰
    system_prompt: str
    tools: Sequence[BaseTool | Callable]
    model: NotRequired[str]      # ç©º=ç»§æ‰¿ä¸» Agent

# å“åº”å¼é…ç½®ï¼ˆdeepagents æ‰©å±•ï¼‰
class ReactiveSubAgentConfig(TypedDict):
    name: str
    description: str
    system_prompt: str
    tools: NotRequired[Sequence[...]]  # ç©º=Simple æ¨¡å¼
    trigger_hook: Literal["after_model"]
    trigger_condition: NotRequired[TriggerCondition]
    context_builder: ContextBuilder     # å¿…å¡«
    result_parser: NotRequired[ResultParser]
    owned_state_keys: list[str]         # ç®¡ç†çš„ state keys
    fallback_on_error: NotRequired[dict]

# ç¼–è¯‘åçš„å­ Agentï¼ˆå†…éƒ¨å®ç°ï¼‰
@dataclass
class CompiledSubAgent:
    name: str
    description: str
    config: SubAgentConfig | ReactiveSubAgentConfig
    runnable: Any = None   # Full Agent æ¨¡å¼
    llm: Any = None        # Simple æ¨¡å¼

    @property
    def is_simple_mode(self) -> bool:
        return self.runnable is None and self.llm is not None
```

##### 8.7.5 æ‰§è¡Œå¼•æ“ (`runner.py`)

`SubAgentRunner` è´Ÿè´£å­ Agent çš„ç¼–è¯‘ä¸è°ƒç”¨ï¼ŒæŒ‰ model æ ‡è¯†ç¼“å­˜ LLM å®ä¾‹ã€‚

```mermaid
flowchart TD
    Config[SubAgentConfig / ReactiveSubAgentConfig] --> Compile{compile}
    Compile --> HasTools{æœ‰ tools?}
    HasTools -- æ˜¯ --> FullAgent[create_agent ç¼–è¯‘<br/>runnable = graph]
    HasTools -- å¦ --> Simple[ç›´æ¥ç¼“å­˜ LLM<br/>llm = ChatOpenAI]
    FullAgent --> Cache[ç¼“å­˜ CompiledSubAgent]
    Simple --> Cache

    subgraph å§”æ´¾è°ƒç”¨
        InvokeD[invoke_delegated] --> IsoState[çŠ¶æ€éš”ç¦»:<br/>ä»…ä¼ å…¥ HumanMessage]
        IsoState --> RunAgent[runnable.invoke]
        RunAgent --> ExtractAI[æå–æœ€å AIMessage]
    end

    subgraph å“åº”è°ƒç”¨
        InvokeR[invoke_reactive] --> CtxBuild[context_builder æå–ä¸Šä¸‹æ–‡]
        CtxBuild --> IsSimple{Simple æ¨¡å¼?}
        IsSimple -- æ˜¯ --> LLMInvoke[llm.invoke<br/>system_prompt + context]
        IsSimple -- å¦ --> AgentInvoke[runnable.invoke]
        LLMInvoke --> Parse[result_parser è§£æ]
        AgentInvoke --> Parse
        Parse --> StateUpdate[è¿”å› state æ›´æ–° dict]
    end
```

å…³é”®è®¾è®¡ï¼š
- **LLM ç¼“å­˜**ï¼šæŒ‰ `model` æ ‡è¯†ç¼“å­˜ `ChatOpenAI` å®ä¾‹ï¼ŒåŒæ¨¡å‹å¤ç”¨
- **ç¼–è¯‘ç¼“å­˜**ï¼šåŒåå­ Agent åªç¼–è¯‘ä¸€æ¬¡
- **é”™è¯¯é™çº§**ï¼šå“åº”å¼è°ƒç”¨ä¸æŠ›å¼‚å¸¸ï¼Œå¤±è´¥æ—¶è¿”å› `fallback_on_error`
- **æ¨¡å‹é…ç½®**ï¼šå­ Agent å¯æŒ‡å®šç‹¬ç«‹ modelï¼Œç©ºå€¼æ—¶ç»§æ‰¿ä¸» Agent æ¨¡å‹ï¼ˆé€šè¿‡ `settings.subagent_model` æˆ– `settings.llm_model`ï¼‰

##### 8.7.6 ç»Ÿä¸€ Middleware (`middleware.py`)

```python
class SubAgentState(AgentState):
    """æ‰©å±• stateï¼Œå£°æ˜ reactive å­ Agent ç®¡ç†çš„ keys"""
    todos: list[dict[str, Any]]  # todo_tracker ç®¡ç†

class SubAgentMiddleware(AgentMiddleware[SubAgentState, ContextT]):
    name = "subagent"
    state_schema = SubAgentState

    def __init__(self, delegated=None, reactive=None):
        # é¢„ç¼–è¯‘æ‰€æœ‰å­ Agent
        self._delegated = {cfg["name"]: runner.compile(cfg) for cfg in delegated}
        self._reactive_by_hook = ...  # æŒ‰ trigger_hook åˆ†ç»„

        # æ„å»º task() toolï¼ˆä»…å½“æœ‰å§”æ´¾å¼å­ Agent æ—¶ï¼‰
        self._task_tool = self._build_task_tool() if self._delegated else None

    @property
    def tools(self) -> list[BaseTool]:
        """task() toolï¼Œéœ€åœ¨ core.py ä¸­åŠ å…¥ä¸» Agent tools åˆ—è¡¨"""
        return [self._task_tool] if self._task_tool else []

    def after_model(self, state, runtime) -> dict | None:
        """è‡ªåŠ¨è§¦å‘ reactive å­ Agentï¼Œåˆå¹¶ state æ›´æ–°"""
        for cfg, compiled in self._reactive_by_hook.get("after_model", []):
            if cfg.trigger_condition and not cfg.trigger_condition(state):
                continue
            update = runner.invoke_reactive(compiled, state)
            merged_updates.update(update)
        return merged_updates
```

**task() tool å·¥ä½œæœºåˆ¶ï¼š**

`_build_task_tool()` åŠ¨æ€æ„å»ºä¸€ä¸ª `task(agent_name, task_description)` å·¥å…·ï¼š
- è‡ªåŠ¨åœ¨ docstring ä¸­åˆ—å‡ºæ‰€æœ‰å¯ç”¨å§”æ´¾å¼å­ Agent åŠå…¶æè¿°
- ä¸» LLM é€šè¿‡ tool description äº†è§£å¯ç”¨å­ Agentï¼Œè‡ªä¸»å†³å®šä½•æ—¶å§”æ´¾
- è·¯ç”±åˆ°å¯¹åº”å­ Agentï¼ŒçŠ¶æ€éš”ç¦»æ‰§è¡Œï¼Œä»…è¿”å›æœ€ç»ˆç»“æœæ–‡æœ¬

##### 8.7.7 TODO è·Ÿè¸ªå™¨å®ç° (`agents/todo_tracker.py`)

ä½œä¸ºæ¡†æ¶çš„é¦–ä¸ªæ¶ˆè´¹è€…ï¼Œ`todo_tracker` ä»¥ Simple æ¨¡å¼ï¼ˆæ—  toolsï¼‰è¿è¡Œï¼š

```python
TODO_TRACKER_CONFIG: ReactiveSubAgentConfig = {
    "name": "todo_tracker",
    "description": "è‡ªåŠ¨è¿½è¸ªå’Œæ›´æ–°ä»»åŠ¡æ­¥éª¤è¿›åº¦",
    "system_prompt": TODO_SYSTEM_PROMPT,  # JSON æ•°ç»„è¾“å‡ºæ ¼å¼
    # æ—  tools â†’ Simple æ¨¡å¼
    "trigger_hook": "after_model",
    "trigger_condition": should_fire,      # ä»… AIMessage æ—¶è§¦å‘
    "context_builder": build_todo_context, # æå–ç²¾ç®€ä¸Šä¸‹æ–‡ â‰¤500 tokens
    "result_parser": parse_todo_result,    # JSON â†’ {"todos": [...]}
    "owned_state_keys": ["todos"],
    "fallback_on_error": {},
}
```

**ä¸‰ä¸ªæ ¸å¿ƒå‡½æ•°ï¼š**

| å‡½æ•° | èŒè´£ | è¦ç‚¹ |
|------|------|------|
| `build_todo_context` | ä» parent state æå–ç²¾ç®€ä¸Šä¸‹æ–‡ | æå–ç”¨æˆ·ä»»åŠ¡ï¼ˆâ‰¤300å­—ç¬¦ï¼‰ã€å½“å‰ TODO çŠ¶æ€ã€æœ€è¿‘8æ¡æ¶ˆæ¯æ‘˜è¦ï¼ˆå·¥å…·è°ƒç”¨å/ç»“æœçŠ¶æ€ï¼‰ |
| `parse_todo_result` | è§£æ LLM JSON è¾“å‡º | æ”¯æŒçº¯ JSON å’Œ markdown ä»£ç å—åŒ…è£¹ï¼›è§„èŒƒåŒ– status å€¼ï¼›è¿‡æ»¤ç©º content |
| `should_fire` | è§¦å‘æ¡ä»¶åˆ¤æ–­ | ä»…å½“æœ€åä¸€æ¡æ¶ˆæ¯æ˜¯ `AIMessage` æ—¶è§¦å‘ï¼Œè·³è¿‡ `ToolMessage` é¿å…ä¸å¿…è¦çš„è°ƒç”¨ |

**æ•°æ®æµï¼š**

```mermaid
sequenceDiagram
    participant Main as ä¸» Agent
    participant MW as SubAgentMiddleware
    participant Todo as todo_tracker
    participant LLM2 as å­ Agent LLM
    participant SSE as SSE Stream

    Main->>MW: after_model(state)
    MW->>Todo: should_fire(state)?
    Todo-->>MW: True (æœ€åæ¶ˆæ¯æ˜¯ AIMessage)
    MW->>Todo: build_todo_context(state)
    Todo-->>MW: [HumanMessage(ç²¾ç®€ä¸Šä¸‹æ–‡)]
    MW->>LLM2: llm.invoke(system_prompt + context)
    LLM2-->>MW: JSON æ•°ç»„æ–‡æœ¬
    MW->>Todo: parse_todo_result(raw_output)
    Todo-->>MW: {"todos": [{content, status}, ...]}
    MW-->>Main: state æ›´æ–°
    Main-->>SSE: todo.state äº‹ä»¶
```

##### 8.7.8 é›†æˆæ–¹å¼ (`core.py`)

```python
from app.agent.subagents import SubAgentMiddleware
from app.agent.subagents.agents.todo_tracker import TODO_TRACKER_CONFIG

def build_agent():
    # åˆ›å»º SubAgentMiddlewareï¼ˆæ›¿ä»£ TodoListMiddlewareï¼‰
    subagent_mw = SubAgentMiddleware(
        delegated=[],                     # å§”æ´¾å¼å­ Agent é…ç½®åˆ—è¡¨
        reactive=[TODO_TRACKER_CONFIG],   # å“åº”å¼å­ Agent é…ç½®åˆ—è¡¨
    )

    all_tools = tool_registry.get_all_tools()
    all_tools.extend(subagent_mw.tools)   # æ³¨å…¥ task() tool

    middleware = [
        subagent_mw,                      # é¦–ä½ï¼šafter_model è§¦å‘ reactive
        SuggestionsMiddleware(),
        MissingParamsMiddleware(...),
        CustomHumanInTheLoopMiddleware(...),
    ]

    agent = create_agent(
        model=llm,
        tools=all_tools,
        system_prompt=SYSTEM_PROMPT,      # å·²åˆ é™¤ write_todos æŒ‡ä»¤
        middleware=middleware,
        checkpointer=_checkpointer,
    )
```

**é…ç½®é¡¹** (`config.py`)ï¼š
- `SUBAGENT_MODEL`ï¼šå­ Agent æ¨¡å‹æ ‡è¯†ç¬¦ã€‚ç©ºå€¼æ—¶å¤ç”¨ä¸»æ¨¡å‹ `LLM_MODEL`ã€‚å…è®¸ä¸ºå­ Agent ä½¿ç”¨æ›´è½»é‡/ä¾¿å®œçš„æ¨¡å‹ã€‚

##### 8.7.9 æ‰©å±•æ–°å­ Agent

```python
# 1. æ–°å»º agents/my_agent.py
from app.agent.subagents.types import ReactiveSubAgentConfig

MY_AGENT_CONFIG: ReactiveSubAgentConfig = {
    "name": "my_agent",
    "description": "è‡ªå®šä¹‰åŠŸèƒ½æè¿°",
    "system_prompt": "...",
    "trigger_hook": "after_model",
    "trigger_condition": lambda state: ...,  # å¯é€‰
    "context_builder": my_context_builder,
    "result_parser": my_result_parser,
    "owned_state_keys": ["my_key"],
    "fallback_on_error": {},
}

# 2. åœ¨ middleware.py çš„ SubAgentState ä¸­å£°æ˜æ–° key
class SubAgentState(AgentState):
    todos: list[dict[str, Any]]
    my_key: ...  # æ–°å¢

# 3. åœ¨ core.py ä¸­æ³¨å†Œ
subagent_mw = SubAgentMiddleware(
    reactive=[TODO_TRACKER_CONFIG, MY_AGENT_CONFIG],
)
```

å¯¹äºå§”æ´¾å¼å­ Agentï¼Œå®šä¹‰ `SubAgentConfig`ï¼ˆå¿…é¡»åŒ…å« `tools`ï¼‰ï¼ŒåŠ å…¥ `delegated` åˆ—è¡¨å³å¯ã€‚æ¡†æ¶è‡ªåŠ¨å°†å…¶æ³¨å†Œåˆ° `task()` tool ä¸­ã€‚

##### 8.7.10 ä¸æ—¢æœ‰ç³»ç»Ÿçš„å…¼å®¹æ€§

| ç»„ä»¶ | å½±å“ | è¯´æ˜ |
|------|------|------|
| `event_mapper.py` | **æ— å˜åŒ–** | ä»æ£€æµ‹ `"todos" in val`ï¼ŒSSE äº‹ä»¶æ ¼å¼ä¸å˜ |
| `api/tasks.py` | **æ— å˜åŒ–** | ä»è¯» `state.values.get("todos")` |
| å‰ç«¯ | **æ— å˜åŒ–** | ä»æ¥æ”¶ `todo.state` äº‹ä»¶ï¼Œæ•°æ®ç»“æ„å…¼å®¹ |
| å…¶ä»– Middleware | **æ— å˜åŒ–** | Suggestions/MissingParams/HITL ä¸å—å½±å“ |
| ç³»ç»Ÿæç¤ºè¯ | **å·²æ›´æ–°** | åˆ é™¤äº† `write_todos` å·¥å…·ä½¿ç”¨æŒ‡ä»¤ |

##### 8.7.11 æµ‹è¯•è¦†ç›–

| æµ‹è¯•ç±»å‹ | æ–‡ä»¶ | ç”¨ä¾‹æ•° | è¦†ç›–å†…å®¹ |
|----------|------|--------|----------|
| å•å…ƒæµ‹è¯•ï¼ˆMockï¼‰ | `test_types.py` | 10 | ç±»å‹å®šä¹‰ã€Simple/Full æ¨¡å¼åˆ¤æ–­ |
| å•å…ƒæµ‹è¯•ï¼ˆMockï¼‰ | `test_todo_tracker.py` | 22 | context_builderã€result_parserã€trigger_condition |
| å•å…ƒæµ‹è¯•ï¼ˆMockï¼‰ | `test_runner.py` | 20 | ç¼–è¯‘ã€å§”æ´¾è°ƒç”¨ã€å“åº”è°ƒç”¨ã€LLM ç¼“å­˜ |
| å•å…ƒæµ‹è¯•ï¼ˆMockï¼‰ | `test_middleware.py` | 13 | åˆå§‹åŒ–ã€after_model hookã€task tool è·¯ç”± |
| å•å…ƒæµ‹è¯•ï¼ˆMockï¼‰ | `test_integration.py` | 16 | E2E ç®¡é“ã€å¤šè½®æ¼”è¿›ã€é”™è¯¯æ¢å¤ã€è‡ªå®šä¹‰æ‰©å±• |
| å®æµ‹ï¼ˆLive LLMï¼‰ | `test_live.py` | 31 | çœŸå® LLM è°ƒç”¨ã€task toolã€å§”æ´¾å­ Agentã€å¤šè½®è¿›åŒ– |
| **åˆè®¡** | | **112** | |

è¿è¡Œæ–¹å¼ï¼š
```bash
cd backend

# å•å…ƒæµ‹è¯•ï¼ˆæ— éœ€ LLM APIï¼‰
pytest tests/ -v

# å®æµ‹ï¼ˆéœ€é…ç½® .env ä¸­çš„ LLM APIï¼‰
pytest tests/test_live.py -v -m live
```

---

### 9. éƒ¨ç½²æ¶æ„è®¾è®¡

#### éªŒè¯é˜¶æ®µï¼ˆå¼€å‘ç¯å¢ƒï¼‰

```mermaid
graph LR
    subgraph æœ¬åœ°å¼€å‘
        FE[React Dev Server :3000] --> BE[FastAPI Uvicorn :8000]
        BE --> InMemory[InMemorySaver]
        BE --> LocalFAISS[æœ¬åœ°FAISS Index]
        BE --> DevMySQL[MySQL Docker :3306]
    end
```

#### ç”Ÿäº§ç¯å¢ƒï¼ˆå¾…å®šï¼Œå»ºè®®æ–¹æ¡ˆï¼‰

```mermaid
graph LR
    subgraph ç”Ÿäº§éƒ¨ç½²
        LB[Nginx / API Gateway] --> FE[React Static :80]
        LB --> BE1[FastAPI Instance 1]
        LB --> BE2[FastAPI Instance 2]
        BE1 --> MySQL[(MySQL)]
        BE2 --> MySQL
        BE1 --> Redis[(Redis - Session)]
        BE2 --> Redis
    end
```

> æ³¨ï¼šç”Ÿäº§éƒ¨ç½²æ¶æ„ä¸ºå»ºè®®æ–¹æ¡ˆï¼Œæœ€ç»ˆæ–¹æ¡ˆå¾…ç¡®å®šï¼ˆTBD #5ï¼‰ã€‚

---

### 10. å¼‚å¸¸å¤„ç†è®¾è®¡

| å¼‚å¸¸åœºæ™¯ | å¤„ç†ç­–ç•¥ | å‰ç«¯å‘ˆç° |
| :--- | :--- | :--- |
| Toolè°ƒç”¨å¤±è´¥ | æ•´ä¸ªä»»åŠ¡æ ‡è®°ä¸ºfailedï¼Œåœæ­¢æ‰§è¡Œ | TODOæ­¥éª¤æ˜¾ç¤ºçº¢è‰²âœ—ï¼Œå¼¹å‡ºé”™è¯¯æç¤º |
| HITL reject | æ•´ä¸ªä»»åŠ¡æ ‡è®°ä¸ºfailedï¼Œåœæ­¢æ‰§è¡Œ | TODOæ­¥éª¤æ˜¾ç¤ºçº¢è‰²âœ—ï¼Œæç¤º"ç”¨æˆ·å·²æ‹’ç»" |
| TODOæ­¥éª¤å¤±è´¥ | æ•´ä¸ªä»»åŠ¡æ ‡è®°ä¸ºfailedï¼Œä¸é‡è¯•/ä¸è·³è¿‡/ä¸å›æ»š | å¯¹åº”æ­¥éª¤çº¢è‰²âœ—ï¼Œåç»­æ­¥éª¤ç°è‰² |
| FAISSæ£€ç´¢å¤±è´¥ | é™çº§ä¸ºæ— æ£€ç´¢æ¨¡å¼ç»§ç»­æ‰§è¡Œ | æ˜¾ç¤ºwarningæç¤º"é¢†åŸŸçŸ¥è¯†æš‚ä¸å¯ç”¨" |
| SSEè¿æ¥æ–­å¼€ | å‰ç«¯è‡ªåŠ¨é‡è¿ï¼ˆEventSource åŸç”Ÿæ”¯æŒï¼‰ | æ˜¾ç¤º"é‡æ–°è¿æ¥ä¸­..."çŠ¶æ€æ¡ |
| LLMè°ƒç”¨è¶…æ—¶ | è¿”å›è¶…æ—¶é”™è¯¯ï¼Œä»»åŠ¡å¤±è´¥ | æ˜¾ç¤ºè¶…æ—¶é”™è¯¯ä¿¡æ¯ |

---

## äºŒã€å¼€å‘è®¡åˆ’ (Roadmap)

### 1. ä¼˜å…ˆçº§æ’åºé€»è¾‘

- **P0ï¼ˆæ ¸å¿ƒé€šè·¯ï¼‰**ï¼šAgentæ¡†æ¶æ­å»ºã€Toolæ³¨å†Œä¸è°ƒç”¨ã€HITLä¸­é—´ä»¶ã€SSEæµå¼è¾“å‡º
- **P1ï¼ˆåŠŸèƒ½å®Œæ•´ï¼‰**ï¼šTODOç®¡ç†ã€SubAgentã€é¢†åŸŸçŸ¥è¯†æ£€ç´¢ã€åŠ¨æ€é…ç½®UI
- **P2ï¼ˆä½“éªŒä¼˜åŒ–ï¼‰**ï¼šUIç²¾ä¿®ï¼ˆUCDè®¾è®¡è§„èŒƒï¼‰ã€è¿›åº¦å¯è§†åŒ–ã€çŸ¥è¯†åº“å¢é‡æ›´æ–°ã€MySQLæŒä¹…åŒ–

### 2. é‡Œç¨‹ç¢‘è§„åˆ’ (Milestones)

```mermaid
gantt
    title WINS Agent å·¥ä½œå°å¼€å‘é‡Œç¨‹ç¢‘
    dateFormat  YYYY-MM-DD
    axisFormat  %m/%d

    section M1: æœ€å°å¯è¡ŒåŸå‹ (MVP)
    é¡¹ç›®åˆå§‹åŒ–ä¸æ¡†æ¶æ­å»º         :m1_1, 2026-02-03, 3d
    LangChain Agent æ ¸å¿ƒé›†æˆ     :m1_2, after m1_1, 4d
    Toolæ³¨å†Œä¸­å¿ƒä¸ç¤ºä¾‹Tool       :m1_3, after m1_2, 3d
    SSEæµå¼è¾“å‡ºï¼ˆåç«¯ï¼‰          :m1_4, after m1_2, 3d
    å‰ç«¯åŸºç¡€æ¡†æ¶ä¸èŠå¤©ç•Œé¢        :m1_5, 2026-02-03, 5d
    å‰åç«¯SSEè”è°ƒ               :m1_6, after m1_4, 2d

    section M2: åŠŸèƒ½å¯¹æ ‡ (Feature Complete)
    HumanInTheLoopä¸­é—´ä»¶é›†æˆ     :m2_1, after m1_6, 3d
    TodoListMiddlewareè‡ªå®šä¹‰å¼€å‘  :m2_2, after m1_6, 4d
    HITLåŠ¨æ€é…ç½®UI              :m2_3, after m2_1, 3d
    TODOå¯è§†åŒ–ç»„ä»¶              :m2_4, after m2_2, 3d
    FAISSé¢†åŸŸçŸ¥è¯†æ£€ç´¢           :m2_5, after m2_2, 4d
    SubAgent-as-Tool            :m2_6, after m2_5, 3d
    ä»»åŠ¡è¿›åº¦é¢æ¿                :m2_7, after m2_4, 2d

    section M3: ç”Ÿäº§å°±ç»ª (Production Ready)
    UCDè®¾è®¡è§„èŒƒUIç²¾ä¿®           :m3_1, after m2_7, 4d
    MySQLæŒä¹…åŒ–æ›¿æ¢InMemory     :m3_2, after m2_6, 3d
    çŸ¥è¯†åº“å¢é‡æ›´æ–°æœºåˆ¶           :m3_3, after m3_2, 3d
    APIé‰´æƒä¸å®‰å…¨åŠ å›º           :m3_4, after m3_2, 2d
    é›†æˆæµ‹è¯•ä¸Bugä¿®å¤           :m3_5, after m3_3, 4d
    éƒ¨ç½²æ–‡æ¡£ä¸ç¯å¢ƒé…ç½®           :m3_6, after m3_5, 2d
```

- **M1: æœ€å°å¯è¡ŒåŸå‹ (MVP)** â€” å®ç° Agent + Toolè°ƒç”¨ + SSEæµå¼èŠå¤©çš„ç«¯åˆ°ç«¯é€šè·¯
- **M2: åŠŸèƒ½å¯¹æ ‡ (Feature Complete)** â€” å®Œæˆå…¨éƒ¨P0åŠŸèƒ½ï¼ˆHITLã€TODOã€çŸ¥è¯†æ£€ç´¢ã€SubAgentï¼‰
- **M3: ç”Ÿäº§å°±ç»ª (Production Ready)** â€” UIç²¾ä¿®ã€æŒä¹…åŒ–ã€å®‰å…¨åŠ å›ºã€æµ‹è¯•

### 3. ä»»åŠ¡åˆ†è§£è¡¨ (WBS)

| é˜¶æ®µ | ä»»åŠ¡ | ä¾èµ– |
| :--- | :--- | :--- |
| **M1** | 1.1 Pythoné¡¹ç›®ç»“æ„åˆå§‹åŒ–ï¼ˆFastAPI + LangChainï¼‰ | - |
| | 1.2 Reactå‰ç«¯é¡¹ç›®åˆå§‹åŒ–ï¼ˆVite + Tailwindï¼‰ | - |
| | 1.3 `create_agent` é›†æˆï¼Œå•Toolè°ƒç”¨éªŒè¯ | 1.1 |
| | 1.4 ToolRegistry å®ç°ä¸3ä¸ªç¤ºä¾‹Tool | 1.3 |
| | 1.5 SSE StreamingResponse å®ç° | 1.3 |
| | 1.6 å‰ç«¯ChatAreaç»„ä»¶ + SSEäº‹ä»¶å¤„ç† | 1.2 |
| | 1.7 å‰åç«¯è”è°ƒï¼Œç«¯åˆ°ç«¯æµå¼å¯¹è¯ | 1.5, 1.6 |
| **M2** | 2.1 HumanInTheLoopMiddleware é›†æˆ | 1.7 |
| | 2.2 TodoListMiddleware è‡ªå®šä¹‰å¼€å‘ | 1.7 |
| | 2.3 HITLå‰ç«¯é…ç½®å¡ç‰‡ï¼ˆDynamicFormï¼‰ | 2.1 |
| | 2.4 TODO Stepper å‰ç«¯ç»„ä»¶ | 2.2 |
| | 2.5 FAISS åŒåº“å»ºè®¾ï¼ˆæœ¯è¯­è¡¨+è®¾è®¡æ–‡æ¡£ï¼‰ | 1.7 |
| | 2.6 Retrieval Tool å®ç° | 2.5 |
| | 2.7 SubAgent å°è£…ä¸æ³¨å†Œ | 2.6 |
| | 2.8 å³ä¾§TaskPanelç»„ä»¶ | 2.4 |
| | 2.9 å·¦ä¾§ConversationSidebarç»„ä»¶ | 1.7 |
| **M3** | 3.1 UCDè®¾è®¡è§„èŒƒå…¨é¢é€‚é… | 2.8, 2.9 |
| | 3.2 InMemorySaver â†’ MySQL Saver è¿ç§» | 2.7 |
| | 3.3 FAISS Index MySQL BLOB å­˜å‚¨ | 3.2 |
| | 3.4 çŸ¥è¯†åº“å¢é‡æ›´æ–°å®šæ—¶ä»»åŠ¡ | 3.3 |
| | 3.5 APIé‰´æƒä¸­é—´ä»¶ | 3.2 |
| | 3.6 é›†æˆæµ‹è¯•ï¼ˆE2Eï¼‰ | 3.1, 3.4, 3.5 |
| | 3.7 éƒ¨ç½²æ–‡æ¡£ç¼–å†™ | 3.6 |

---

## ä¸‰ã€éœ€è‡ªå®šä¹‰å¼€å‘çš„æ¨¡å—è¯´æ˜

ä»¥ä¸‹æ¨¡å—éœ€è‡ªå®šä¹‰å¼€å‘ï¼ˆLangChain 1.2.5 æä¾›äº† `TodoListMiddleware`ã€`HumanInTheLoopMiddleware` ç­‰åŸç”Ÿä¸­é—´ä»¶ï¼Œå·²å……åˆ†åˆ©ç”¨ï¼‰ï¼š

| æ¨¡å— | è¯´æ˜ | å¼€å‘é‡è¯„ä¼° |
| :--- | :--- | :--- |
| ~~TodoListMiddleware~~ | ~~åŸç”Ÿ TodoListMiddleware~~ â†’ å·²è¢« **ç»Ÿä¸€ SubAgent æ‰©å±•æ¡†æ¶** ä¸­çš„ `todo_tracker` å“åº”å¼å­ Agent å–ä»£ï¼ˆè§ 8.7 èŠ‚ï¼‰ï¼Œè§£å†³å¤šè½®å¯¹è¯ TODO åœæ­¢åˆ·æ–°çš„é—®é¢˜ã€‚ | å·²å®Œæˆ |
| **SSEäº‹ä»¶åˆ†å‘å±‚** | LangChain çš„ `agent.stream()` è¿”å›åŸå§‹äº‹ä»¶æµï¼Œéœ€è‡ªè¡Œå°†å…¶è½¬æ¢ä¸ºå‰ç«¯æ‰€éœ€çš„ç»“æ„åŒ– SSE äº‹ä»¶ï¼ˆthinking/tool.call/tool.result/todo.state/hitl.pendingï¼‰ã€‚ | ä¸­ |
| **HITLå‰ç«¯äº¤äº’æ¡¥æ¥** | `HumanInTheLoopMiddleware` æä¾›äº†é˜»å¡æœºåˆ¶ï¼Œä½†å‰ç«¯HITLå†³ç­–çš„æäº¤-resolve é€šé“éœ€è‡ªè¡Œæ­å»ºï¼ˆåŸºäº checkpointer + `Command(resume=...)` resolveï¼‰ã€‚ | ä¸­ |
| **FAISS Index MySQLæŒä¹…åŒ–** | LangChain çš„ FAISS VectorStore æ”¯æŒæœ¬åœ°æ–‡ä»¶æŒä¹…åŒ–ï¼ˆ`save_local`/`load_local`ï¼‰ï¼Œä½† MySQL BLOB å­˜å‚¨éœ€è‡ªè¡Œåºåˆ—åŒ–/ååºåˆ—åŒ–ã€‚MVPé˜¶æ®µä½¿ç”¨æ–‡ä»¶æŒä¹…åŒ–ã€‚ | ä½ |
| **çŸ¥è¯†åº“å¢é‡æ›´æ–°** | æ–‡æ¡£ hash å¯¹æ¯” + å¢é‡ Embedding + FAISS Index è¿½åŠ æ›´æ–°é€»è¾‘éœ€è‡ªè¡Œå®ç°ã€‚ | ä½ |
| **å…¨éƒ¨å‰ç«¯UI** | Reactå·¥ä½œå°ã€ä¸‰æ å¸ƒå±€ã€TODO Stepperã€HITLé…ç½®å¡ç‰‡ã€åŠ¨æ€è¡¨å•ç­‰å‰ç«¯ç»„ä»¶ã€‚ | é«˜ |

---

## å››ã€ä¾èµ–ç‰ˆæœ¬é”å®šå»ºè®®ï¼ˆrequirements.txtï¼‰

```txt
langchain==1.2.5
faiss-cpu>=1.8.0,<2.0.0
fastapi>=0.115.0,<1.0.0
uvicorn[standard]>=0.30.0
pydantic>=2.0.0,<3.0.0
pymysql>=1.1.0
sqlalchemy>=2.0.0,<3.0.0
python-dotenv>=1.0.0
```

```json
// package.json (å‰ç«¯æ ¸å¿ƒä¾èµ–)
{
  "dependencies": {
    "react": "^18.3.0",
    "react-dom": "^18.3.0",
    "zustand": "^4.5.0",
    "tailwindcss": "^3.4.0"
  },
  "devDependencies": {
    "typescript": "^5.5.0",
    "vite": "^5.4.0",
    "@types/react": "^18.3.0"
  }
}
```
