# AI Agent å·¥ä½œå° - æŠ€æœ¯è®¾è®¡æ–‡æ¡£

> åŸºäº LangChain 1.2.5 çš„æ™ºèƒ½ä»£ç†å·¥ä½œå°ç³»ç»ŸæŠ€æœ¯è§£å†³æ–¹æ¡ˆä¸å¼€å‘è®¡åˆ’

---

## ä¸€ã€è§£å†³æ–¹æ¡ˆ

### 1. ç³»ç»Ÿæ¦‚è¿°

- **ç³»ç»Ÿå®šä½**ï¼šé¢å‘å­˜é‡ç³»ç»Ÿé›†æˆçš„ AI Agent å·¥ä½œå°ï¼Œä½œä¸ºç”¨æˆ·ä¸100+å­˜é‡ç³»ç»Ÿ API ä¹‹é—´çš„æ™ºèƒ½ç¼–æ’å±‚ï¼Œè‡ªåŠ¨ç†è§£ç”¨æˆ·æ„å›¾ã€æ£€ç´¢é¢†åŸŸçŸ¥è¯†ã€ç»„æ’ Tool è°ƒç”¨é“¾å¹¶ä»¥å¯è§†åŒ–æ–¹å¼å‘ˆç°æ‰§è¡Œè¿‡ç¨‹ã€‚

- **æ ¸å¿ƒèƒ½åŠ›çŸ©é˜µ**ï¼š

| èƒ½åŠ›åŸŸ | æ ¸å¿ƒåŠŸèƒ½ | æŠ€æœ¯æ”¯æ’‘ |
| :--- | :--- | :--- |
| æ„å›¾ç†è§£ | è‡ªç„¶è¯­è¨€æ„å›¾è¯†åˆ«ä¸Toolæ˜ å°„ | LangChain 1.2.5 `create_agent` + LLM tool binding |
| é¢†åŸŸçŸ¥è¯† | ä¸“ä¸šæœ¯è¯­è¡¨/è®¾è®¡æ–‡æ¡£çš„å‘é‡æ£€ç´¢ | FAISS + `langchain-community` VectorStore |
| Toolç¼–æ’ | 100ä»¥å†…Toolçš„ä¾èµ–å…³ç³»ç®¡ç†ä¸ä¸²è¡Œè°ƒç”¨ | `@tool` è£…é¥°å™¨ + descriptionä¾èµ–æ¨æ–­ |
| ä»»åŠ¡åˆ†å‘ | SubAgentå°è£…ä¸ºä¸»Agentçš„Tool | Agent-as-Tool æ¨¡å¼ï¼ˆ`@tool` åŒ…è£… `invoke`ï¼‰ |
| äººæœºäº¤äº’ | Toolè°ƒç”¨å‰çš„approve/edit/reject | `HumanInTheLoopMiddleware` |
| æµå¼è¾“å‡º | Tokençº§å®æ—¶æ¨é€ | SSE + `agent.stream()` |
| TODOç®¡ç† | æ­¥éª¤çŠ¶æ€è·Ÿè¸ªä¸å¯è§†åŒ– | è‡ªå®šä¹‰ `TodoListMiddleware` |

- **è®¾è®¡çº¦æŸ**ï¼š
    - åŠŸèƒ½çº¦æŸï¼šä¸æ”¯æŒå¹¶è¡ŒToolè°ƒç”¨ï¼›Tool/TODOæ­¥éª¤å¤±è´¥ä¸é‡è¯•ä¸å›æ»šï¼Œç›´æ¥ç»ˆæ­¢ä»»åŠ¡
    - æ€§èƒ½è§„æ ¼ï¼šFAISSæ£€ç´¢ â‰¤ 500msï¼ŒSSEå»¶è¿Ÿ â‰¤ 100msï¼Œé…ç½®é¢æ¿å“åº” â‰¤ 1s
    - æŠ€æœ¯çº¦æŸï¼šå¿…é¡»åŸºäº LangChain 1.2.5ï¼Œä¼˜å…ˆä½¿ç”¨æ¡†æ¶åŸç”Ÿç‰¹æ€§

---

### 2. ä¸‰æ–¹ä»¶é€‰å‹ä¸å…¼å®¹æ€§åˆ†æ

#### 2.1 é€‰å‹å†³ç­–è®°å½• (ADR)

| ç»„ä»¶ç±»åˆ« | å¾…é€‰æ–¹æ¡ˆ | æœ€ç»ˆé€‰å‹ | ç†ç”± (Why) | æ½œåœ¨é£é™© |
| :--- | :--- | :--- | :--- | :--- |
| Agentæ¡†æ¶ | LangChain 1.2.5 vs LlamaIndex vs è‡ªç ” | **LangChain 1.2.5** | éœ€æ±‚å¼ºåˆ¶æŒ‡å®šï¼›æä¾› `create_agent`ã€`middleware`ã€`stream` åŸç”Ÿæ”¯æŒ | 1.2.5ä¸ºæ–°ç‰ˆæœ¬ï¼Œç¤¾åŒºæ¡ˆä¾‹æœ‰é™ |
| å‘é‡æ£€ç´¢ | FAISS vs ChromaDB vs Milvus | **FAISS (faiss-cpu)** | éœ€æ±‚æŒ‡å®šï¼›è½»é‡çº§ã€æ— éœ€ç‹¬ç«‹éƒ¨ç½²ã€ä¸ langchain-community é›†æˆæˆç†Ÿ | å•æœºæ€§èƒ½ä¸Šé™ï¼Œä¸æ”¯æŒåˆ†å¸ƒå¼ |
| Embeddingæ¨¡å‹ | OpenAI Embedding vs HuggingFace | **å¾…å®šï¼ˆè·ŸéšLLMé€‰å‹ï¼‰** | éœ€ä¸LLMæä¾›å•†ä¿æŒä¸€è‡´æ€§ | å¤šæ¨¡å‹æ··ç”¨å¢åŠ è¿ç»´æˆæœ¬ |
| æŒä¹…åŒ–å­˜å‚¨ | MySQL vs PostgreSQL vs SQLite | **MySQL** | éœ€æ±‚æŒ‡å®šï¼›FAISS Indexä»¥BLOBå­˜å‚¨ï¼›éªŒè¯é˜¶æ®µç”¨ `InMemorySaver` | BLOBå­—æ®µæŸ¥è¯¢æ•ˆç‡éœ€å…³æ³¨ |
| å‰ç«¯æ¡†æ¶ | React vs Vue vs Svelte | **React + Tailwind CSS** | éœ€æ±‚æŒ‡å®šï¼›ç”Ÿæ€æˆç†Ÿï¼ŒTailwindç¬¦åˆUCDè®¾è®¡è§„èŒƒçš„åŸå­åŒ–éœ€æ±‚ | æ—  |
| åç«¯æ¡†æ¶ | FastAPI vs Flask vs Django | **FastAPI** | åŸç”Ÿæ”¯æŒSSEï¼ˆ`StreamingResponse`ï¼‰ã€asyncã€ç±»å‹å®‰å…¨ | éœ€å¼•å…¥ `uvicorn` ä½œä¸º ASGI æœåŠ¡å™¨ |
| çŠ¶æ€ç®¡ç†(å‰ç«¯) | Zustand vs Redux vs Jotai | **Zustand** | è½»é‡çº§ã€APIç®€æ´ã€ä¸SSEäº‹ä»¶é©±åŠ¨æ¨¡å¼å¥‘åˆ | ç¤¾åŒºè§„æ¨¡å°äºRedux |
| Checkpointer | InMemorySaver vs MySQL Saver | **InMemorySaverï¼ˆéªŒè¯é˜¶æ®µï¼‰** | LangChain 1.2.5 åŸç”Ÿæä¾›ï¼›ç”Ÿäº§é˜¶æ®µè¿ç§»è‡³ MySQL è‡ªå®šä¹‰å®ç° | å†…å­˜æ•°æ®ä¸æŒä¹… |

#### 2.2 æŠ€æœ¯æ ˆå…¼å®¹æ€§çŸ©é˜µ

| æ ¸å¿ƒç»„ä»¶ | æ¨èç‰ˆæœ¬ | å…¼å®¹æ€§è¦æ±‚/ä¾èµ– | è¯´æ˜ |
| :--- | :--- | :--- | :--- |
| **Python** | 3.11+ | >= 3.10 | LangChain 1.2.5 æœ€ä½è¦æ±‚ |
| **langchain** | 1.2.5 | éœ€é…åˆ langchain-core 0.3.x | Agentæ ¸å¿ƒæ¡†æ¶ |
| **langchain-community** | 0.3.x | ä¸ langchain 1.2.5 å¯¹é½ | FAISS VectorStore é›†æˆ |
| **faiss-cpu** | 1.8.x | éœ€ numpy >= 1.24 | å‘é‡æ£€ç´¢å¼•æ“ |
| **FastAPI** | 0.115.x | éœ€ uvicorn 0.30+, pydantic v2 | åç«¯APIæ¡†æ¶ |
| **React** | 18.x | éœ€ Node.js >= 18 | å‰ç«¯æ¡†æ¶ |
| **Tailwind CSS** | 3.4.x | éœ€ PostCSS 8.x | åŸå­åŒ–CSSæ¡†æ¶ |
| **MySQL** | 8.0+ | éœ€ pymysql æˆ– aiomysql | æŒä¹…åŒ–å­˜å‚¨ |
| **Zustand** | 4.x | React 18+ | å‰ç«¯çŠ¶æ€ç®¡ç† |

#### 2.3 é€‰å‹æ‹“æ‰‘å›¾

```mermaid
graph LR
    subgraph å‰ç«¯
        React[React 18] --> TailwindCSS[Tailwind CSS 3.4]
        React --> Zustand[Zustand 4.x]
        React --> SSEClient[EventSource API]
    end

    subgraph åç«¯
        FastAPI[FastAPI 0.115] --> LangChain[LangChain 1.2.5]
        LangChain --> LangChainCore[langchain-core 0.3.x]
        LangChain --> LangChainCommunity[langchain-community 0.3.x]
        LangChainCommunity --> FAISS[faiss-cpu 1.8.x]
        FastAPI --> MySQL[MySQL 8.0]
    end

    SSEClient -. SSE .-> FastAPI
    FAISS -. BLOBå­˜å‚¨ .-> MySQL
```

---

### 3. ç³»ç»Ÿæ¶æ„è®¾è®¡

#### 3.1 åˆ†å±‚æ¶æ„è§†å›¾

```mermaid
graph TD
    subgraph æ¥å…¥å±‚
        UI[React å‰ç«¯å·¥ä½œå°] --> SSE[SSE EventSource]
        UI --> REST[REST API]
    end

    subgraph APIç½‘å…³å±‚
        SSE --> FastAPI[FastAPI Server]
        REST --> FastAPI
        FastAPI --> Auth[é‰´æƒä¸­é—´ä»¶]
    end

    subgraph ä¸šåŠ¡é€»è¾‘å±‚
        Auth --> AgentCore[Agent ä¸»å…¥å£]
        AgentCore --> Middleware[Middleware Pipeline]
        Middleware --> HITL[HumanInTheLoopMiddleware]
        Middleware --> TodoMW[TodoListMiddleware]
        AgentCore --> ToolRegistry[Tool æ³¨å†Œä¸­å¿ƒ]
        AgentCore --> SubAgentMgr[SubAgent ç®¡ç†å™¨]
        AgentCore --> KnowledgeRetriever[é¢†åŸŸçŸ¥è¯†æ£€ç´¢å™¨]
    end

    subgraph æ•°æ®å±‚
        ToolRegistry --> LegacyAPI[å­˜é‡ç³»ç»Ÿ API]
        KnowledgeRetriever --> FAISSIndex[FAISS å‘é‡ç´¢å¼•]
        FAISSIndex --> MySQL[(MySQL)]
        AgentCore --> Checkpointer[InMemorySaver / MySQL Saver]
    end
```

#### 3.2 ç»„ä»¶äº¤äº’è§†å›¾

```mermaid
graph LR
    User((ç”¨æˆ·)) --> Frontend[React å·¥ä½œå°]
    Frontend --> |REST/SSE| Backend[FastAPI]
    Backend --> MainAgent[ä¸»Agent]
    MainAgent --> |middleware| HITLMiddleware[HITLä¸­é—´ä»¶]
    MainAgent --> |middleware| TodoMiddleware[TODOä¸­é—´ä»¶]
    MainAgent --> |tool call| ToolRegistry[Toolæ³¨å†Œä¸­å¿ƒ]
    MainAgent --> |tool call| SubAgent[SubAgent-as-Tool]
    MainAgent --> |retrieval| FAISSRetriever[FAISSæ£€ç´¢å™¨]
    SubAgent --> |tool call| ToolRegistry
    ToolRegistry --> LegacySystem[å­˜é‡ç³»ç»Ÿ]
    FAISSRetriever --> VectorStore[(FAISS Index)]
    VectorStore --> MySQL[(MySQL BLOB)]
```

---

### 4. æ ¸å¿ƒä¸šåŠ¡æµ

#### 4.1 ä¸»æµç¨‹ï¼šç”¨æˆ·è¾“å…¥ â†’ Agentæ‰§è¡Œ â†’ æµå¼è¾“å‡º

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·/å‰ç«¯
    participant API as FastAPI
    participant Agent as ä¸»Agent
    participant MW as Middleware Pipeline
    participant LLM as LLM
    participant FAISS as FAISSæ£€ç´¢
    participant Tool as Tool/SubAgent
    participant SSE as SSE Stream

    U->>API: POST /api/chat (ç”¨æˆ·è¾“å…¥)
    API->>Agent: agent.stream({messages})
    Agent->>MW: TodoMiddleware.before_model()
    MW-->>SSE: todo.state äº‹ä»¶ (åˆå§‹åŒ–TODO)
    Agent->>LLM: å‘é€æ¶ˆæ¯ + Toolæè¿°
    LLM-->>SSE: thinking äº‹ä»¶ (Tokenæµ)

    alt è¯†åˆ«åˆ°ä¸“ä¸šæœ¯è¯­
        Agent->>FAISS: é¢†åŸŸçŸ¥è¯†æ£€ç´¢
        FAISS-->>Agent: è¿”å›ç›¸å…³æ–‡æ¡£ç‰‡æ®µ
        Agent->>LLM: è¡¥å……é¢†åŸŸçŸ¥è¯†ä¸Šä¸‹æ–‡
    end

    LLM-->>Agent: é€‰æ‹©Tool + å‚æ•°
    SSE-->>U: tool.call äº‹ä»¶ (Toolåç§°+å‚æ•°)

    alt HumanInTheLoopè§¦å‘
        MW->>U: é˜»å¡ç­‰å¾…ç”¨æˆ·ç¡®è®¤
        U-->>MW: approve / edit / reject
        alt reject
            MW-->>Agent: ä»»åŠ¡ç»ˆæ­¢
            SSE-->>U: error äº‹ä»¶
        end
    end

    Agent->>Tool: æ‰§è¡ŒToolè°ƒç”¨
    Tool-->>Agent: è¿”å›ç»“æœ
    SSE-->>U: tool.result äº‹ä»¶
    MW-->>SSE: todo.state äº‹ä»¶ (æ›´æ–°æ­¥éª¤çŠ¶æ€)

    Agent->>LLM: å¤„ç†Toolç»“æœ
    LLM-->>SSE: thinking äº‹ä»¶
    LLM-->>Agent: æœ€ç»ˆå›å¤
    SSE-->>U: message äº‹ä»¶ (å®Œæ•´å›å¤)
```

#### 4.2 Human-in-the-Loop äº¤äº’æµç¨‹

```mermaid
sequenceDiagram
    participant Agent as ä¸»Agent
    participant HITL as HumanInTheLoopMiddleware
    participant SSE as SSE Stream
    participant U as ç”¨æˆ·/å‰ç«¯

    Agent->>HITL: Toolè°ƒç”¨å‰æ‹¦æˆª
    HITL->>SSE: hitl.pending äº‹ä»¶ (Toolå+å‚æ•°+schema)
    SSE->>U: å±•ç¤ºé…ç½®å¡ç‰‡ (å¯ç¼–è¾‘å‚æ•°)

    alt approve
        U->>SSE: hitl.approve (åŸå§‹å‚æ•°)
        SSE->>HITL: ç»§ç»­æ‰§è¡Œ
        HITL->>Agent: æ”¾è¡ŒToolè°ƒç”¨
    else edit
        U->>SSE: hitl.edit (ä¿®æ”¹åå‚æ•°)
        SSE->>HITL: ä½¿ç”¨æ–°å‚æ•°
        HITL->>Agent: ä»¥ä¿®æ”¹å‚æ•°æ‰§è¡ŒTool
    else reject
        U->>SSE: hitl.reject
        SSE->>HITL: ç»ˆæ­¢
        HITL->>Agent: æŠ›å‡ºå¼‚å¸¸ï¼Œä»»åŠ¡å¤±è´¥
    end
```

#### 4.3 TODOçŠ¶æ€ç®¡ç†æµç¨‹

```mermaid
stateDiagram-v2
    [*] --> pending: åˆå§‹åŒ–
    pending --> in_progress: Agentå¼€å§‹æ‰§è¡Œè¯¥æ­¥éª¤
    in_progress --> completed: æ­¥éª¤æ‰§è¡ŒæˆåŠŸ
    in_progress --> failed: æ­¥éª¤æ‰§è¡Œå¤±è´¥
    failed --> [*]: æ•´ä¸ªä»»åŠ¡ç»ˆæ­¢
    completed --> [*]: æ‰€æœ‰æ­¥éª¤å®Œæˆ
    in_progress --> replan: LLMå†³å®šè°ƒæ•´è®¡åˆ’
    replan --> pending: é‡æ–°è§„åˆ’æ­¥éª¤
```

---

### 5. æ•°æ®æ¨¡å‹è®¾è®¡

#### 5.1 æ ¸å¿ƒå®ä½“å…³ç³»å›¾

```mermaid
erDiagram
    CONVERSATION ||--o{ MESSAGE : contains
    CONVERSATION ||--o{ TASK : triggers
    TASK ||--o{ TODO_STEP : decomposes
    TASK ||--o{ TOOL_EXECUTION : records
    TODO_STEP ||--o| TOOL_EXECUTION : maps_to
    KNOWLEDGE_BASE ||--o{ KNOWLEDGE_DOCUMENT : stores
    KNOWLEDGE_BASE ||--|| FAISS_INDEX : indexes
    TOOL_DEFINITION ||--o{ TOOL_EXECUTION : instances

    CONVERSATION {
        string id PK
        string session_id
        datetime created_at
        datetime updated_at
    }

    MESSAGE {
        string id PK
        string conversation_id FK
        string role "user/assistant/tool"
        text content
        json tool_calls "nullable"
        datetime created_at
    }

    TASK {
        string id PK
        string conversation_id FK
        string status "pending/in_progress/completed/failed"
        text description
        datetime created_at
        datetime updated_at
    }

    TODO_STEP {
        string id PK
        string task_id FK
        int order_index
        string status "pending/in_progress/completed/failed/replan"
        text description
        text result "nullable"
        datetime created_at
        datetime updated_at
    }

    TOOL_EXECUTION {
        string id PK
        string task_id FK
        string todo_step_id FK "nullable"
        string tool_name
        json input_params
        json output_result "nullable"
        string hitl_status "auto/approved/edited/rejected"
        json hitl_edited_params "nullable"
        string status "pending/running/success/failed"
        datetime created_at
        datetime completed_at "nullable"
    }

    TOOL_DEFINITION {
        string name PK
        text description
        json parameters_schema
        string category "è€—æ—¶/å¤æ‚/å¤–éƒ¨è°ƒç”¨"
        boolean requires_hitl
        json dependencies "ä¾èµ–çš„å…¶ä»–Toolåç§°åˆ—è¡¨"
    }

    KNOWLEDGE_BASE {
        string id PK
        string name "æœ¯è¯­è¡¨/è®¾è®¡æ–‡æ¡£"
        string type "terminology/design_doc"
        datetime last_updated
    }

    KNOWLEDGE_DOCUMENT {
        string id PK
        string knowledge_base_id FK
        string file_path
        text content
        string content_hash "å¢é‡æ›´æ–°æ ¡éªŒ"
        datetime created_at
    }

    FAISS_INDEX {
        string id PK
        string knowledge_base_id FK
        blob index_data "FAISSåºåˆ—åŒ–äºŒè¿›åˆ¶"
        int dimension
        int doc_count
        datetime created_at
    }
```

#### 5.2 æ ¸å¿ƒæ•°æ®åº“è¡¨è®¾è®¡

| è¡¨å | å­—æ®µ | ç±»å‹ | è¯´æ˜ |
| :--- | :--- | :--- | :--- |
| **conversations** | id | VARCHAR(36) PK | UUID |
| | session_id | VARCHAR(36) | ç”¨æˆ·ä¼šè¯æ ‡è¯† |
| | created_at | DATETIME | åˆ›å»ºæ—¶é—´ |
| **messages** | id | VARCHAR(36) PK | UUID |
| | conversation_id | VARCHAR(36) FK | å…³è”ä¼šè¯ |
| | role | ENUM('user','assistant','tool') | æ¶ˆæ¯è§’è‰² |
| | content | TEXT | æ¶ˆæ¯å†…å®¹ |
| | tool_calls | JSON | Toolè°ƒç”¨ä¿¡æ¯ï¼ˆnullableï¼‰ |
| **tasks** | id | VARCHAR(36) PK | UUID |
| | conversation_id | VARCHAR(36) FK | å…³è”ä¼šè¯ |
| | status | ENUM('pending','in_progress','completed','failed') | ä»»åŠ¡çŠ¶æ€ |
| | description | TEXT | ä»»åŠ¡æè¿° |
| **todo_steps** | id | VARCHAR(36) PK | UUID |
| | task_id | VARCHAR(36) FK | å…³è”ä»»åŠ¡ |
| | order_index | INT | æ­¥éª¤åºå· |
| | status | ENUM('pending','in_progress','completed','failed','replan') | æ­¥éª¤çŠ¶æ€ |
| | description | TEXT | æ­¥éª¤æè¿° |
| | result | TEXT | æ‰§è¡Œç»“æœï¼ˆnullableï¼‰ |
| **tool_executions** | id | VARCHAR(36) PK | UUID |
| | task_id | VARCHAR(36) FK | å…³è”ä»»åŠ¡ |
| | tool_name | VARCHAR(128) | Toolåç§° |
| | input_params | JSON | è¾“å…¥å‚æ•° |
| | output_result | JSON | è¾“å‡ºç»“æœï¼ˆnullableï¼‰ |
| | hitl_status | ENUM('auto','approved','edited','rejected') | HITLå†³ç­– |
| | status | ENUM('pending','running','success','failed') | æ‰§è¡ŒçŠ¶æ€ |
| **faiss_indexes** | id | VARCHAR(36) PK | UUID |
| | knowledge_base_id | VARCHAR(36) FK | å…³è”çŸ¥è¯†åº“ |
| | index_data | LONGBLOB | FAISSåºåˆ—åŒ–ç´¢å¼• |
| | dimension | INT | å‘é‡ç»´åº¦ |
| | doc_count | INT | æ–‡æ¡£æ•°é‡ |

---

### 6. API æ¥å£è®¾è®¡

#### 6.1 æ¥å£çŸ©é˜µ

| Method | Path | è¯´æ˜ | è¯·æ±‚ä½“ | å“åº” |
| :--- | :--- | :--- | :--- | :--- |
| POST | `/api/chat` | å‘èµ·å¯¹è¯ï¼ˆSSEæµå¼ï¼‰ | `ChatRequest` | SSE EventStream |
| POST | `/api/hitl/{execution_id}/decide` | HITLå†³ç­–æäº¤ | `HITLDecision` | `200 OK` |
| GET | `/api/conversations` | è·å–ä¼šè¯åˆ—è¡¨ | - | `Conversation[]` |
| GET | `/api/conversations/{id}` | è·å–ä¼šè¯è¯¦æƒ…åŠæ¶ˆæ¯ | - | `ConversationDetail` |
| GET | `/api/tasks/{task_id}/todos` | è·å–TODOæ­¥éª¤åˆ—è¡¨ | - | `TodoStep[]` |
| POST | `/api/knowledge/rebuild` | è§¦å‘çŸ¥è¯†åº“é‡å»º | `RebuildRequest` | `202 Accepted` |
| GET | `/api/tools` | è·å–å·²æ³¨å†ŒToolåˆ—è¡¨ | - | `ToolDefinition[]` |

#### 6.2 API äº¤äº’æ—¶åºå›¾

```mermaid
sequenceDiagram
    participant FE as React å‰ç«¯
    participant API as FastAPI
    participant Agent as Agent Core

    FE->>API: POST /api/chat {message, conversation_id}
    API->>Agent: agent.stream(...)
    loop SSE Events
        Agent-->>API: yield event
        API-->>FE: SSE: event_type + data
    end

    Note over FE: æ”¶åˆ° hitl.pending äº‹ä»¶

    FE->>FE: å±•ç¤ºé…ç½®å¡ç‰‡, ç”¨æˆ·æ“ä½œ
    FE->>API: POST /api/hitl/{id}/decide {action, params}
    API->>Agent: resolve HITL interrupt
    Agent-->>API: ç»§ç»­æ‰§è¡Œ
    API-->>FE: SSE: tool.result
```

#### 6.3 æ¥å£å¥‘çº¦

**POST /api/chat - è¯·æ±‚ä½“**
```json
{
  "conversation_id": "string | null",
  "message": "string"
}
```

**SSE Event æ ¼å¼**
```
event: {event_type}
data: {json_payload}

```

| event_type | data ç»“æ„ | è¯´æ˜ |
| :--- | :--- | :--- |
| `thinking` | `{"token": "string"}` | LLM Tokenæµå¼è¾“å‡º |
| `tool.call` | `{"tool_name": "string", "params": {}, "execution_id": "string"}` | Toolè°ƒç”¨å¼€å§‹ |
| `tool.result` | `{"execution_id": "string", "result": {}, "status": "success/failed"}` | Toolè°ƒç”¨ç»“æœ |
| `hitl.pending` | `{"execution_id": "string", "tool_name": "string", "params": {}, "schema": {}}` | ç­‰å¾…HITLå†³ç­– |
| `todo.state` | `{"task_id": "string", "steps": [{"id","description","status"}]}` | TODOçŠ¶æ€æ›´æ–° |
| `message` | `{"content": "string"}` | æœ€ç»ˆå›å¤ |
| `error` | `{"code": "string", "message": "string"}` | é”™è¯¯ä¿¡æ¯ |

**POST /api/hitl/{execution_id}/decide - è¯·æ±‚ä½“**
```json
{
  "action": "approve | edit | reject",
  "edited_params": {}
}
```

**çŠ¶æ€ç å®šä¹‰**

| çŠ¶æ€ç  | è¯´æ˜ |
| :--- | :--- |
| 200 | æˆåŠŸ |
| 202 | å·²æ¥å—ï¼ˆå¼‚æ­¥å¤„ç†ï¼‰ |
| 400 | è¯·æ±‚å‚æ•°é”™è¯¯ |
| 401 | æœªæˆæƒ |
| 404 | èµ„æºä¸å­˜åœ¨ |
| 500 | æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ |

---

### 7. å‰ç«¯æ¶æ„è®¾è®¡

#### 7.1 æŠ€æœ¯æ ˆ

- **æ¡†æ¶**ï¼šReact 18 + TypeScript
- **æ ·å¼**ï¼šTailwind CSS 3.4ï¼ˆéµå¾ªUCDè®¾è®¡è§„èŒƒï¼‰
- **çŠ¶æ€ç®¡ç†**ï¼šZustand 4.x
- **é€šä¿¡**ï¼šEventSource API (SSE) + Fetch API (REST)
- **æ„å»ºå·¥å…·**ï¼šVite

#### 7.2 è®¾è®¡ç³»ç»Ÿ Tokenï¼ˆåŸºäºUCDè®¾è®¡.mdï¼‰

```typescript
// design-tokens.ts
export const colors = {
  primary:    '#A78BFA', // è–°è¡£è‰ç´« - äº¤äº’é«˜äº®ã€ç¡®è®¤æŒ‰é’®
  secondary:  '#60A5FA', // å¤©ç©ºè“   - è¿è¡Œä¸­çŠ¶æ€
  success:    '#34D399', // è–„è·ç»¿   - å®ŒæˆçŠ¶æ€
  error:      '#F87171', // çŠç‘šçº¢   - å¤±è´¥çŠ¶æ€
  background: '#FAFAFA', // é¡µé¢èƒŒæ™¯
  card:       '#FFFFFF', // ç»„ä»¶å¡ç‰‡
  textPrimary:   '#1F2937', // ä¸»æ–‡å­—
  textSecondary: '#6B7280', // æ¬¡æ–‡å­—
  textWeak:      '#9CA3AF', // å¼±æ–‡å­—
} as const;

export const spacing = {
  grid: 8,     // 8px åŸºå‡†ç½‘æ ¼
  gutter: 24,  // æ …æ ¼é—´è·
  columns: 12, // 12æ ç½‘æ ¼
} as const;

export const typography = {
  fontFamily: "'Inter', -apple-system, sans-serif",
} as const;
```

#### 7.3 ç»„ä»¶æ¶æ„æ‹†è§£

```mermaid
graph TD
    App[App] --> Layout[WorkstationLayout ä¸‰æ å¸ƒå±€]
    Layout --> Sidebar[ConversationSidebar å·¦ä¾§è¾¹æ ]
    Layout --> ChatArea[ChatArea ä¸­é—´èŠå¤©åŒº]
    Layout --> TaskPanel[TaskPanel å³ä¾§ä»»åŠ¡é¢æ¿]

    Sidebar --> ConvList[ConversationList]
    Sidebar --> ConvItem[ConversationItem]

    ChatArea --> MessageList[MessageList]
    ChatArea --> MessageBubble[MessageBubble]
    ChatArea --> InputBar[ChatInputBar]
    MessageBubble --> TodoStepper[TodoStepper åµŒå…¥å¼TODO]
    MessageBubble --> ToolCallCard[ToolCallCard Toolè°ƒç”¨å¡ç‰‡]
    MessageBubble --> ThinkingIndicator[ThinkingIndicator æ€è€ƒä¸­]

    TodoStepper --> StepItem[StepItem æ­¥éª¤é¡¹]
    StepItem --> StatusIcon[StatusIcon çŠ¶æ€å›¾æ ‡]
    StepItem --> ProgressBar[ProgressBar è¿›åº¦æ¡]

    ToolCallCard --> HITLModal[HITLConfigModal é…ç½®å¼¹çª—]
    HITLModal --> DynamicForm[DynamicForm åŠ¨æ€è¡¨å•]
    HITLModal --> ActionButtons[ActionButtons approve/edit/reject]

    TaskPanel --> TaskList[TaskList]
    TaskPanel --> TaskCard[TaskCard ä»»åŠ¡å¡ç‰‡]
    TaskCard --> TaskProgress[TaskProgressBar]
    TaskCard --> TaskStatus[TaskStatusBadge]
```

#### 7.4 Zustand Store è®¾è®¡

```typescript
// stores/chatStore.ts
interface ChatStore {
  // ä¼šè¯ç®¡ç†
  conversations: Conversation[];
  activeConversationId: string | null;

  // æ¶ˆæ¯
  messages: Message[];

  // TODOçŠ¶æ€
  todoSteps: Record<string, TodoStep[]>; // taskId -> steps

  // HITL
  pendingHITL: HITLPending | null;

  // SSEè¿æ¥
  sseConnection: EventSource | null;

  // Actions
  sendMessage: (content: string) => void;
  handleSSEEvent: (event: SSEEvent) => void;
  submitHITLDecision: (executionId: string, decision: HITLDecision) => void;
}
```

#### 7.5 ä¸‰æ å¸ƒå±€ç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WINS Agent å·¥ä½œå°                              [ç”¨æˆ·å¤´åƒ] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚            â”‚                          â”‚                  â”‚
â”‚  å¯¹è¯å†å²    â”‚   èŠå¤©åŒºåŸŸ                â”‚   ä»»åŠ¡è¿›åº¦é¢æ¿    â”‚
â”‚            â”‚                          â”‚                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ä¼šè¯1 â”‚  â”‚  â”‚ AI: æˆ‘å·²åˆ†ææ‚¨çš„éœ€æ±‚  â”‚ â”‚  â”‚ ä»»åŠ¡#1      â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”¤  â”‚  â”‚                     â”‚ â”‚  â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ 4/6  â”‚ â”‚
â”‚  â”‚ ä¼šè¯2 â”‚  â”‚  â”‚ â”Œâ”€ TODO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”¤  â”‚  â”‚ â”‚ âœ“ æ­¥éª¤1 å·²å®Œæˆ   â”‚â”‚ â”‚  â”‚ ä»»åŠ¡#2      â”‚ â”‚
â”‚  â”‚ ä¼šè¯3 â”‚  â”‚  â”‚ â”‚ â— æ­¥éª¤2 æ‰§è¡Œä¸­   â”‚â”‚ â”‚  â”‚ â–ˆâ–ˆâ–‘â–‘â–‘â–‘ 2/6  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚ â”‚ â—‹ æ­¥éª¤3 å¾…æ‰§è¡Œ   â”‚â”‚ â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚            â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â”‚                  â”‚
â”‚            â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                  â”‚
â”‚            â”‚                          â”‚                  â”‚
â”‚            â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                  â”‚
â”‚            â”‚  â”‚ [é…ç½®å¡ç‰‡ - HITL]    â”‚ â”‚                  â”‚
â”‚            â”‚  â”‚  å‚æ•°1: [____]      â”‚ â”‚                  â”‚
â”‚            â”‚  â”‚  å‚æ•°2: [â–¼ ä¸‹æ‹‰]    â”‚ â”‚                  â”‚
â”‚            â”‚  â”‚ [Approve] [Reject]  â”‚ â”‚                  â”‚
â”‚            â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                  â”‚
â”‚            â”‚                          â”‚                  â”‚
â”‚            â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                  â”‚
â”‚            â”‚  â”‚ ğŸ“  è¾“å…¥æ¶ˆæ¯...      â”‚ â”‚                  â”‚
â”‚            â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Â© WINS Agent                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 8. å…³é”®ç‰¹æ€§è®¾è®¡

#### 8.1 é¢†åŸŸçŸ¥è¯†ç®¡ç†æ¨¡å—

**æ¶æ„**ï¼šåŒåº“åˆ†ç¦»ï¼ˆæœ¯è¯­è¡¨åº“ + è®¾è®¡æ–‡æ¡£åº“ï¼‰ï¼Œå„è‡ªç‹¬ç«‹ FAISS Indexã€‚

```mermaid
graph LR
    subgraph çŸ¥è¯†ç®¡ç†
        MD1[æœ¯è¯­è¡¨ .md] --> Splitter1[æ–‡æœ¬åˆ†å‰²å™¨]
        MD2[è®¾è®¡æ–‡æ¡£ .md] --> Splitter2[æ–‡æœ¬åˆ†å‰²å™¨]
        Splitter1 --> Embed1[Embeddingæ¨¡å‹]
        Splitter2 --> Embed2[Embeddingæ¨¡å‹]
        Embed1 --> FAISS1[(æœ¯è¯­è¡¨ FAISS Index)]
        Embed2 --> FAISS2[(è®¾è®¡æ–‡æ¡£ FAISS Index)]
        FAISS1 --> MySQL1[(MySQL BLOB)]
        FAISS2 --> MySQL2[(MySQL BLOB)]
    end
```

**æ£€ç´¢è§¦å‘æœºåˆ¶**ï¼š

```python
# æ–¹å¼ï¼šä½œä¸ºAgentçš„Retrieval Toolï¼Œç”±LLMè‡ªä¸»å†³å®šä½•æ—¶è°ƒç”¨
@tool(response_format="content_and_artifact")
def search_terminology(query: str):
    """å½“é‡åˆ°ä¸“ä¸šæœ¯è¯­æˆ–éœ€è¦æŸ¥è¯¢æœ¯è¯­å®šä¹‰æ—¶ï¼Œä½¿ç”¨æ­¤å·¥å…·æ£€ç´¢ä¸“ä¸šæœ¯è¯­è¡¨ã€‚"""
    docs = terminology_vector_store.similarity_search(query, k=3)
    serialized = "\n\n".join(
        f"æœ¯è¯­: {doc.metadata.get('term', 'N/A')}\nå®šä¹‰: {doc.page_content}"
        for doc in docs
    )
    return serialized, docs

@tool(response_format="content_and_artifact")
def search_design_doc(query: str):
    """å½“éœ€è¦äº†è§£å­˜é‡ç³»ç»Ÿè®¾è®¡æˆ–æ¥å£è§„èŒƒæ—¶ï¼Œä½¿ç”¨æ­¤å·¥å…·æ£€ç´¢ç³»ç»Ÿè®¾è®¡æ–‡æ¡£ã€‚"""
    docs = design_doc_vector_store.similarity_search(query, k=3)
    serialized = "\n\n".join(
        f"æ¥æº: {doc.metadata.get('source', 'N/A')}\nå†…å®¹: {doc.page_content}"
        for doc in docs
    )
    return serialized, docs
```

**å¢é‡æ›´æ–°ç­–ç•¥**ï¼š
1. è®¡ç®—æ–‡æ¡£ content_hashï¼ˆMD5ï¼‰ï¼Œä¸æ•°æ®åº“ä¸­å·²å­˜è®°å½•å¯¹æ¯”
2. ä»…å¯¹æ–°å¢/å˜æ›´çš„æ–‡æ¡£é‡æ–°ç”Ÿæˆ Embedding å¹¶è¿½åŠ åˆ° FAISS Index
3. æ›´æ–°åçš„ FAISS Index åºåˆ—åŒ–ä¸ºäºŒè¿›åˆ¶å­˜å…¥ MySQL BLOB å­—æ®µ
4. æ›´æ–°é¢‘ç‡ç”±å®šæ—¶ä»»åŠ¡æ§åˆ¶ï¼ˆå…·ä½“é—´éš” TBDï¼‰

#### 8.2 Toolç¼–æ’ä¸æ³¨å†Œä¸­å¿ƒ

**è®¾è®¡åŸåˆ™**ï¼š
- æ¯ä¸ªToolä½¿ç”¨ `@tool` è£…é¥°å™¨å°è£…ï¼Œdescriptionä¸­å£°æ˜ä¾èµ–å…³ç³»
- LLMé€šè¿‡descriptionç†è§£ä¾èµ–å¹¶æŒ‰åºè°ƒç”¨ï¼ˆä¸æ”¯æŒå¹¶è¡Œè°ƒç”¨ï¼‰
- æ”¯æŒé™æ€ä¾èµ–ï¼ˆdescriptionä¸­å£°æ˜ï¼‰+ åŠ¨æ€æ¨æ–­ï¼ˆLLMæ ¹æ®ä¸Šä¸‹æ–‡åˆ¤æ–­ï¼‰

```python
from langchain.tools import tool

@tool
def create_order(
    customer_id: str,
    product_codes: list[str],
    quantities: list[int],
    delivery_address: str
):
    """åˆ›å»ºè®¢å•ã€‚ä¾èµ–å…³ç³»ï¼šè°ƒç”¨å‰éœ€å…ˆé€šè¿‡ validate_customer éªŒè¯å®¢æˆ·æœ‰æ•ˆæ€§ï¼Œ
    å¹¶é€šè¿‡ check_inventory ç¡®è®¤åº“å­˜å……è¶³ã€‚

    å‚æ•°è¯´æ˜ï¼š
    - customer_id: å®¢æˆ·ç¼–ç ï¼ˆå¯é€šè¿‡ search_customer å·¥å…·æŸ¥è¯¢ï¼‰
    - product_codes: äº§å“ç¼–ç åˆ—è¡¨ï¼ˆéœ€ç¬¦åˆERPç¼–ç è§„èŒƒï¼‰
    - quantities: å¯¹åº”äº§å“çš„æ•°é‡åˆ—è¡¨
    - delivery_address: é…é€åœ°å€ï¼ˆéœ€åŒ…å«çœå¸‚åŒºï¼‰
    """
    # è°ƒç”¨å­˜é‡ç³»ç»ŸAPI
    return legacy_api.create_order(...)
```

**Toolæ³¨å†Œä¸­å¿ƒç±»å›¾**ï¼š

```mermaid
classDiagram
    class ToolRegistry {
        -tools: Dict[str, StructuredTool]
        -categories: Dict[str, List[str]]
        +register(tool: StructuredTool, category: str)
        +get_all_tools() List[StructuredTool]
        +get_tools_by_category(category: str) List[StructuredTool]
        +get_tool_schema(name: str) Dict
    }

    class ToolCategory {
        <<enumeration>>
        QUERY: æŸ¥è¯¢ç±»
        MUTATION: å˜æ›´ç±»
        LONG_RUNNING: è€—æ—¶ç±»
        EXTERNAL: å¤–éƒ¨è°ƒç”¨ç±»
    }

    class ToolWrapper {
        +name: str
        +description: str
        +parameters_schema: Dict
        +requires_hitl: bool
        +dependencies: List[str]
        +invoke(params: Dict) Any
    }

    ToolRegistry "1" --> "*" ToolWrapper : manages
    ToolWrapper --> ToolCategory : categorized_by
```

#### 8.3 Agent-as-Toolï¼ˆSubAgentæ¨¡å¼ï¼‰

åŸºäº LangChain 1.2.5 çš„ Agent-as-Tool æ¨¡å¼ï¼ŒSubAgent ä½œä¸ºä¸»Agent çš„ Tool è¢«è°ƒç”¨ï¼š

```python
from langchain.agents import create_agent
from langchain.tools import tool

# åˆ›å»ºä¸“ä¸šåŒ–SubAgent
data_analysis_agent = create_agent(
    model="...",
    tools=[query_database, generate_chart, export_csv],
    prompt="ä½ æ˜¯æ•°æ®åˆ†æä¸“å®¶ï¼Œè´Ÿè´£æ‰§è¡Œæ•°æ®æŸ¥è¯¢ã€åˆ†æå’Œå¯è§†åŒ–ä»»åŠ¡ã€‚"
)

# åŒ…è£…ä¸ºä¸»Agentçš„Tool
@tool("data_analysis", description="æ‰§è¡Œæ•°æ®åˆ†æä»»åŠ¡ï¼ŒåŒ…æ‹¬æ•°æ®æŸ¥è¯¢ã€ç»Ÿè®¡åˆ†æå’Œå›¾è¡¨ç”Ÿæˆã€‚é€‚ç”¨äºéœ€è¦å¤šæ­¥æ•°æ®å¤„ç†çš„å¤æ‚åˆ†æè¯·æ±‚ã€‚")
def call_data_analysis(query: str) -> str:
    """å°†å¤æ‚æ•°æ®åˆ†æä»»åŠ¡å§”æ´¾ç»™æ•°æ®åˆ†æä¸“å®¶SubAgentã€‚"""
    result = data_analysis_agent.invoke({
        "messages": [{"role": "user", "content": query}]
    })
    return result["messages"][-1].content

# ä¸»Agentæ³¨å†ŒSubAgent Tool
main_agent = create_agent(
    model="...",
    tools=[call_data_analysis, ...other_tools],
    middleware=[...],
    prompt="ä½ æ˜¯AI Agentå·¥ä½œå°çš„ä¸»è°ƒåº¦å™¨..."
)
```

**SubAgentåˆ†å‘å†³ç­–**ï¼šLLM æ ¹æ® Tool description è‡ªä¸»åˆ¤æ–­æ˜¯å¦éœ€è¦åˆ†å‘ç»™ SubAgentã€‚åˆ†å‘æ ‡å‡†å»ºè®®åœ¨ description ä¸­ä½“ç°ï¼š
- æ¶‰åŠå¤šæ­¥éª¤ä¸²è¡Œæ“ä½œ
- å±äºç‰¹å®šä¸“ä¸šé¢†åŸŸï¼ˆæ•°æ®åˆ†æã€æŠ¥è¡¨ç”Ÿæˆç­‰ï¼‰
- é¢„è®¡è€—æ—¶è¾ƒé•¿çš„å¤åˆä»»åŠ¡

#### 8.4 TodoListMiddleware è®¾è®¡

> **æ³¨æ„**ï¼šLangChain 1.2.5 æœªæä¾› `TodoListMiddleware` é¢„å»ºä¸­é—´ä»¶ã€‚éœ€åŸºäº `AgentMiddleware` åŸºç±»è‡ªå®šä¹‰å®ç°ã€‚

```python
from langchain.agents.middleware import AgentMiddleware

class TodoListMiddleware(AgentMiddleware):
    """è‡ªå®šä¹‰TODOç®¡ç†ä¸­é—´ä»¶ï¼Œè·Ÿè¸ªAgentä»»åŠ¡æ­¥éª¤çŠ¶æ€ã€‚"""

    def __init__(self):
        self.steps: list[dict] = []
        self.current_step_index: int = -1
        self.task_id: str | None = None

    async def before_model(self, state, config):
        """æ¨¡å‹è°ƒç”¨å‰ï¼šæ£€æŸ¥å½“å‰TODOçŠ¶æ€ï¼Œæ³¨å…¥æ­¥éª¤ä¸Šä¸‹æ–‡ã€‚"""
        if self.steps:
            todo_context = self._format_todo_context()
            # å°†TODOçŠ¶æ€æ³¨å…¥åˆ°ç³»ç»Ÿæ¶ˆæ¯ä¸­
            state["messages"].insert(0, {
                "role": "system",
                "content": f"å½“å‰ä»»åŠ¡æ­¥éª¤çŠ¶æ€:\n{todo_context}\nè¯·æ ¹æ®æ­¥éª¤è®¡åˆ’ç»§ç»­æ‰§è¡Œã€‚"
            })
        return state

    async def after_model(self, state, config):
        """æ¨¡å‹è°ƒç”¨åï¼šè§£æLLMè¾“å‡ºï¼Œæ›´æ–°æ­¥éª¤çŠ¶æ€ã€‚"""
        last_message = state["messages"][-1]
        # è§£æLLMæ˜¯å¦è¾“å‡ºäº†æ–°çš„TODOè®¡åˆ’æˆ–çŠ¶æ€å˜æ›´
        self._parse_and_update_steps(last_message)
        # é€šè¿‡å›è°ƒé€šçŸ¥å‰ç«¯
        if config.get("callbacks"):
            await self._emit_todo_state(config["callbacks"])
        return state

    async def before_tool(self, tool_call, config):
        """Toolè°ƒç”¨å‰ï¼šå°†å¯¹åº”æ­¥éª¤æ ‡è®°ä¸º in_progressã€‚"""
        self._advance_step("in_progress")
        return tool_call

    async def after_tool(self, tool_result, config):
        """Toolè°ƒç”¨åï¼šæ ¹æ®ç»“æœæ›´æ–°æ­¥éª¤çŠ¶æ€ã€‚"""
        if tool_result.get("error"):
            self._advance_step("failed")
        else:
            self._advance_step("completed")
        return tool_result

    def _format_todo_context(self) -> str:
        status_icons = {
            "pending": "â—‹", "in_progress": "â—",
            "completed": "âœ“", "failed": "âœ—", "replan": "â†»"
        }
        lines = []
        for i, step in enumerate(self.steps):
            icon = status_icons.get(step["status"], "?")
            lines.append(f"  {icon} æ­¥éª¤{i+1}: {step['description']} [{step['status']}]")
        return "\n".join(lines)

    def _advance_step(self, status: str):
        if 0 <= self.current_step_index < len(self.steps):
            self.steps[self.current_step_index]["status"] = status

    def _parse_and_update_steps(self, message):
        # è§£æLLMè¾“å‡ºä¸­çš„TODOè®¡åˆ’ï¼ˆæ ¼å¼çº¦å®šï¼‰
        pass

    async def _emit_todo_state(self, callbacks):
        # å‘é€todo.state SSEäº‹ä»¶
        pass
```

#### 8.5 HumanInTheLoopMiddleware é›†æˆ

ä½¿ç”¨ LangChain 1.2.5 åŸç”Ÿ `HumanInTheLoopMiddleware`ï¼š

```python
from langchain.agents import create_agent
from langchain.agents.middleware import HumanInTheLoopMiddleware
from langgraph.checkpoint.memory import InMemorySaver

# å®šä¹‰éœ€è¦HITLç¡®è®¤çš„Toolåˆ—è¡¨
hitl_tools = {
    "create_order": True,
    "update_customer": True,
    "delete_record": True,
    # ... æ•æ„Ÿæ“ä½œTool
}

agent = create_agent(
    llm,
    tools=tool_registry.get_all_tools(),
    prompt=system_prompt,
    middleware=[
        TodoListMiddleware(),  # è‡ªå®šä¹‰
        HumanInTheLoopMiddleware(
            interrupt_on=hitl_tools,
            description_prefix="è¯¥æ“ä½œéœ€è¦æ‚¨ç¡®è®¤",
        ),
    ],
    checkpointer=InMemorySaver(),
)
```

**å‰ç«¯HITLäº¤äº’**ï¼š
1. Agentæ‰§è¡Œåˆ°éœ€HITLçš„Toolæ—¶ï¼Œä¸­é—´ä»¶é˜»å¡å¹¶é€šè¿‡SSEæ¨é€ `hitl.pending` äº‹ä»¶
2. å‰ç«¯å±•ç¤ºåŠ¨æ€é…ç½®å¡ç‰‡ï¼ˆDynamicFormï¼‰ï¼Œè¡¨å•Schemaç”±Toolçš„ `parameters_schema` ç”Ÿæˆ
3. LLMæ¨æ–­çš„é»˜è®¤å€¼é¢„å¡«å…¥è¡¨å•
4. ç”¨æˆ·é€‰æ‹© approveï¼ˆç¡®è®¤ï¼‰/ editï¼ˆä¿®æ”¹å‚æ•°ï¼‰/ rejectï¼ˆæ‹’ç»ï¼‰
5. å‰ç«¯é€šè¿‡ `POST /api/hitl/{execution_id}/decide` æäº¤å†³ç­–
6. åç«¯ resolve HITL interruptï¼ŒAgentç»§ç»­æˆ–ç»ˆæ­¢

#### 8.6 SSE æµå¼è¾“å‡ºè®¾è®¡

```python
from fastapi import FastAPI
from fastapi.responses import StreamingResponse

app = FastAPI()

async def stream_agent_events(conversation_id: str, message: str):
    """ç”ŸæˆSSEäº‹ä»¶æµã€‚"""
    agent_stream = agent.stream(
        {"messages": [{"role": "user", "content": message}]},
        config={"configurable": {"thread_id": conversation_id}},
    )

    for event in agent_stream:
        # æ ¹æ®äº‹ä»¶ç±»å‹è½¬æ¢ä¸ºSSEæ ¼å¼
        if "messages" in event:
            msg = event["messages"][-1]
            if hasattr(msg, 'tool_calls') and msg.tool_calls:
                for tc in msg.tool_calls:
                    yield f"event: tool.call\ndata: {json.dumps({'tool_name': tc['name'], 'params': tc['args']})}\n\n"
            elif hasattr(msg, 'content') and msg.content:
                yield f"event: thinking\ndata: {json.dumps({'token': msg.content})}\n\n"

@app.post("/api/chat")
async def chat(request: ChatRequest):
    return StreamingResponse(
        stream_agent_events(request.conversation_id, request.message),
        media_type="text/event-stream",
        headers={
            "Cache-Control": "no-cache",
            "Connection": "keep-alive",
            "X-Accel-Buffering": "no",
        }
    )
```

---

### 9. éƒ¨ç½²æ¶æ„è®¾è®¡

#### éªŒè¯é˜¶æ®µï¼ˆå¼€å‘ç¯å¢ƒï¼‰

```mermaid
graph LR
    subgraph æœ¬åœ°å¼€å‘
        FE[React Dev Server :3000] --> BE[FastAPI Uvicorn :8000]
        BE --> InMemory[InMemorySaver]
        BE --> LocalFAISS[æœ¬åœ°FAISS Index]
        BE --> DevMySQL[MySQL Docker :3306]
    end
```

#### ç”Ÿäº§ç¯å¢ƒï¼ˆå¾…å®šï¼Œå»ºè®®æ–¹æ¡ˆï¼‰

```mermaid
graph LR
    subgraph ç”Ÿäº§éƒ¨ç½²
        LB[Nginx / API Gateway] --> FE[React Static :80]
        LB --> BE1[FastAPI Instance 1]
        LB --> BE2[FastAPI Instance 2]
        BE1 --> MySQL[(MySQL)]
        BE2 --> MySQL
        BE1 --> Redis[(Redis - Session)]
        BE2 --> Redis
    end
```

> æ³¨ï¼šç”Ÿäº§éƒ¨ç½²æ¶æ„ä¸ºå»ºè®®æ–¹æ¡ˆï¼Œæœ€ç»ˆæ–¹æ¡ˆå¾…ç¡®å®šï¼ˆTBD #5ï¼‰ã€‚

---

### 10. å¼‚å¸¸å¤„ç†è®¾è®¡

| å¼‚å¸¸åœºæ™¯ | å¤„ç†ç­–ç•¥ | å‰ç«¯å‘ˆç° |
| :--- | :--- | :--- |
| Toolè°ƒç”¨å¤±è´¥ | æ•´ä¸ªä»»åŠ¡æ ‡è®°ä¸ºfailedï¼Œåœæ­¢æ‰§è¡Œ | TODOæ­¥éª¤æ˜¾ç¤ºçº¢è‰²âœ—ï¼Œå¼¹å‡ºé”™è¯¯æç¤º |
| HITL reject | æ•´ä¸ªä»»åŠ¡æ ‡è®°ä¸ºfailedï¼Œåœæ­¢æ‰§è¡Œ | TODOæ­¥éª¤æ˜¾ç¤ºçº¢è‰²âœ—ï¼Œæç¤º"ç”¨æˆ·å·²æ‹’ç»" |
| TODOæ­¥éª¤å¤±è´¥ | æ•´ä¸ªä»»åŠ¡æ ‡è®°ä¸ºfailedï¼Œä¸é‡è¯•/ä¸è·³è¿‡/ä¸å›æ»š | å¯¹åº”æ­¥éª¤çº¢è‰²âœ—ï¼Œåç»­æ­¥éª¤ç°è‰² |
| FAISSæ£€ç´¢å¤±è´¥ | é™çº§ä¸ºæ— æ£€ç´¢æ¨¡å¼ç»§ç»­æ‰§è¡Œ | æ˜¾ç¤ºwarningæç¤º"é¢†åŸŸçŸ¥è¯†æš‚ä¸å¯ç”¨" |
| SSEè¿æ¥æ–­å¼€ | å‰ç«¯è‡ªåŠ¨é‡è¿ï¼ˆEventSource åŸç”Ÿæ”¯æŒï¼‰ | æ˜¾ç¤º"é‡æ–°è¿æ¥ä¸­..."çŠ¶æ€æ¡ |
| LLMè°ƒç”¨è¶…æ—¶ | è¿”å›è¶…æ—¶é”™è¯¯ï¼Œä»»åŠ¡å¤±è´¥ | æ˜¾ç¤ºè¶…æ—¶é”™è¯¯ä¿¡æ¯ |

---

## äºŒã€å¼€å‘è®¡åˆ’ (Roadmap)

### 1. ä¼˜å…ˆçº§æ’åºé€»è¾‘

- **P0ï¼ˆæ ¸å¿ƒé€šè·¯ï¼‰**ï¼šAgentæ¡†æ¶æ­å»ºã€Toolæ³¨å†Œä¸è°ƒç”¨ã€HITLä¸­é—´ä»¶ã€SSEæµå¼è¾“å‡º
- **P1ï¼ˆåŠŸèƒ½å®Œæ•´ï¼‰**ï¼šTODOç®¡ç†ã€SubAgentã€é¢†åŸŸçŸ¥è¯†æ£€ç´¢ã€åŠ¨æ€é…ç½®UI
- **P2ï¼ˆä½“éªŒä¼˜åŒ–ï¼‰**ï¼šUIç²¾ä¿®ï¼ˆUCDè®¾è®¡è§„èŒƒï¼‰ã€è¿›åº¦å¯è§†åŒ–ã€çŸ¥è¯†åº“å¢é‡æ›´æ–°ã€MySQLæŒä¹…åŒ–

### 2. é‡Œç¨‹ç¢‘è§„åˆ’ (Milestones)

```mermaid
gantt
    title WINS Agent å·¥ä½œå°å¼€å‘é‡Œç¨‹ç¢‘
    dateFormat  YYYY-MM-DD
    axisFormat  %m/%d

    section M1: æœ€å°å¯è¡ŒåŸå‹ (MVP)
    é¡¹ç›®åˆå§‹åŒ–ä¸æ¡†æ¶æ­å»º         :m1_1, 2026-02-03, 3d
    LangChain Agent æ ¸å¿ƒé›†æˆ     :m1_2, after m1_1, 4d
    Toolæ³¨å†Œä¸­å¿ƒä¸ç¤ºä¾‹Tool       :m1_3, after m1_2, 3d
    SSEæµå¼è¾“å‡ºï¼ˆåç«¯ï¼‰          :m1_4, after m1_2, 3d
    å‰ç«¯åŸºç¡€æ¡†æ¶ä¸èŠå¤©ç•Œé¢        :m1_5, 2026-02-03, 5d
    å‰åç«¯SSEè”è°ƒ               :m1_6, after m1_4, 2d

    section M2: åŠŸèƒ½å¯¹æ ‡ (Feature Complete)
    HumanInTheLoopä¸­é—´ä»¶é›†æˆ     :m2_1, after m1_6, 3d
    TodoListMiddlewareè‡ªå®šä¹‰å¼€å‘  :m2_2, after m1_6, 4d
    HITLåŠ¨æ€é…ç½®UI              :m2_3, after m2_1, 3d
    TODOå¯è§†åŒ–ç»„ä»¶              :m2_4, after m2_2, 3d
    FAISSé¢†åŸŸçŸ¥è¯†æ£€ç´¢           :m2_5, after m2_2, 4d
    SubAgent-as-Tool            :m2_6, after m2_5, 3d
    ä»»åŠ¡è¿›åº¦é¢æ¿                :m2_7, after m2_4, 2d

    section M3: ç”Ÿäº§å°±ç»ª (Production Ready)
    UCDè®¾è®¡è§„èŒƒUIç²¾ä¿®           :m3_1, after m2_7, 4d
    MySQLæŒä¹…åŒ–æ›¿æ¢InMemory     :m3_2, after m2_6, 3d
    çŸ¥è¯†åº“å¢é‡æ›´æ–°æœºåˆ¶           :m3_3, after m3_2, 3d
    APIé‰´æƒä¸å®‰å…¨åŠ å›º           :m3_4, after m3_2, 2d
    é›†æˆæµ‹è¯•ä¸Bugä¿®å¤           :m3_5, after m3_3, 4d
    éƒ¨ç½²æ–‡æ¡£ä¸ç¯å¢ƒé…ç½®           :m3_6, after m3_5, 2d
```

- **M1: æœ€å°å¯è¡ŒåŸå‹ (MVP)** â€” å®ç° Agent + Toolè°ƒç”¨ + SSEæµå¼èŠå¤©çš„ç«¯åˆ°ç«¯é€šè·¯
- **M2: åŠŸèƒ½å¯¹æ ‡ (Feature Complete)** â€” å®Œæˆå…¨éƒ¨P0åŠŸèƒ½ï¼ˆHITLã€TODOã€çŸ¥è¯†æ£€ç´¢ã€SubAgentï¼‰
- **M3: ç”Ÿäº§å°±ç»ª (Production Ready)** â€” UIç²¾ä¿®ã€æŒä¹…åŒ–ã€å®‰å…¨åŠ å›ºã€æµ‹è¯•

### 3. ä»»åŠ¡åˆ†è§£è¡¨ (WBS)

| é˜¶æ®µ | ä»»åŠ¡ | ä¾èµ– |
| :--- | :--- | :--- |
| **M1** | 1.1 Pythoné¡¹ç›®ç»“æ„åˆå§‹åŒ–ï¼ˆFastAPI + LangChainï¼‰ | - |
| | 1.2 Reactå‰ç«¯é¡¹ç›®åˆå§‹åŒ–ï¼ˆVite + Tailwindï¼‰ | - |
| | 1.3 `create_agent` é›†æˆï¼Œå•Toolè°ƒç”¨éªŒè¯ | 1.1 |
| | 1.4 ToolRegistry å®ç°ä¸3ä¸ªç¤ºä¾‹Tool | 1.3 |
| | 1.5 SSE StreamingResponse å®ç° | 1.3 |
| | 1.6 å‰ç«¯ChatAreaç»„ä»¶ + SSEäº‹ä»¶å¤„ç† | 1.2 |
| | 1.7 å‰åç«¯è”è°ƒï¼Œç«¯åˆ°ç«¯æµå¼å¯¹è¯ | 1.5, 1.6 |
| **M2** | 2.1 HumanInTheLoopMiddleware é›†æˆ | 1.7 |
| | 2.2 TodoListMiddleware è‡ªå®šä¹‰å¼€å‘ | 1.7 |
| | 2.3 HITLå‰ç«¯é…ç½®å¡ç‰‡ï¼ˆDynamicFormï¼‰ | 2.1 |
| | 2.4 TODO Stepper å‰ç«¯ç»„ä»¶ | 2.2 |
| | 2.5 FAISS åŒåº“å»ºè®¾ï¼ˆæœ¯è¯­è¡¨+è®¾è®¡æ–‡æ¡£ï¼‰ | 1.7 |
| | 2.6 Retrieval Tool å®ç° | 2.5 |
| | 2.7 SubAgent å°è£…ä¸æ³¨å†Œ | 2.6 |
| | 2.8 å³ä¾§TaskPanelç»„ä»¶ | 2.4 |
| | 2.9 å·¦ä¾§ConversationSidebarç»„ä»¶ | 1.7 |
| **M3** | 3.1 UCDè®¾è®¡è§„èŒƒå…¨é¢é€‚é… | 2.8, 2.9 |
| | 3.2 InMemorySaver â†’ MySQL Saver è¿ç§» | 2.7 |
| | 3.3 FAISS Index MySQL BLOB å­˜å‚¨ | 3.2 |
| | 3.4 çŸ¥è¯†åº“å¢é‡æ›´æ–°å®šæ—¶ä»»åŠ¡ | 3.3 |
| | 3.5 APIé‰´æƒä¸­é—´ä»¶ | 3.2 |
| | 3.6 é›†æˆæµ‹è¯•ï¼ˆE2Eï¼‰ | 3.1, 3.4, 3.5 |
| | 3.7 éƒ¨ç½²æ–‡æ¡£ç¼–å†™ | 3.6 |

---

## ä¸‰ã€éœ€è‡ªå®šä¹‰å¼€å‘çš„æ¨¡å—è¯´æ˜

ä»¥ä¸‹æ¨¡å— **LangChain 1.2.5 æœªæä¾›å¼€ç®±å³ç”¨çš„å®ç°**ï¼Œéœ€è‡ªå®šä¹‰å¼€å‘ï¼š

| æ¨¡å— | è¯´æ˜ | å¼€å‘é‡è¯„ä¼° |
| :--- | :--- | :--- |
| **TodoListMiddleware** | LangChain 1.2.5 ä»…æä¾› `HumanInTheLoopMiddleware`ã€`SummarizationMiddleware`ã€`PIIRedactionMiddleware` ä¸‰ä¸ªé¢„å»ºä¸­é—´ä»¶ï¼Œä¸å« TODO ç®¡ç†ã€‚éœ€åŸºäº `AgentMiddleware` åŸºç±»è‡ªå®šä¹‰å®ç°ã€‚ | ä¸­ |
| **SSEäº‹ä»¶åˆ†å‘å±‚** | LangChain çš„ `agent.stream()` è¿”å›åŸå§‹äº‹ä»¶æµï¼Œéœ€è‡ªè¡Œå°†å…¶è½¬æ¢ä¸ºå‰ç«¯æ‰€éœ€çš„ç»“æ„åŒ– SSE äº‹ä»¶ï¼ˆthinking/tool.call/tool.result/todo.state/hitl.pendingï¼‰ã€‚ | ä¸­ |
| **HITLå‰ç«¯äº¤äº’æ¡¥æ¥** | `HumanInTheLoopMiddleware` æä¾›äº†é˜»å¡æœºåˆ¶ï¼Œä½†å‰ç«¯HITLå†³ç­–çš„æäº¤-resolve é€šé“éœ€è‡ªè¡Œæ­å»ºï¼ˆåŸºäº checkpointer + interrupt resolveï¼‰ã€‚ | ä¸­ |
| **FAISS Index MySQLæŒä¹…åŒ–** | LangChain çš„ FAISS VectorStore æ”¯æŒæœ¬åœ°æ–‡ä»¶æŒä¹…åŒ–ï¼ˆ`save_local`/`load_local`ï¼‰ï¼Œä½† MySQL BLOB å­˜å‚¨éœ€è‡ªè¡Œåºåˆ—åŒ–/ååºåˆ—åŒ–ã€‚ | ä½ |
| **çŸ¥è¯†åº“å¢é‡æ›´æ–°** | æ–‡æ¡£ hash å¯¹æ¯” + å¢é‡ Embedding + FAISS Index è¿½åŠ æ›´æ–°é€»è¾‘éœ€è‡ªè¡Œå®ç°ã€‚ | ä½ |
| **å…¨éƒ¨å‰ç«¯UI** | Reactå·¥ä½œå°ã€ä¸‰æ å¸ƒå±€ã€TODO Stepperã€HITLé…ç½®å¡ç‰‡ã€åŠ¨æ€è¡¨å•ç­‰å‰ç«¯ç»„ä»¶ã€‚ | é«˜ |

---

## å››ã€ä¾èµ–ç‰ˆæœ¬é”å®šå»ºè®®ï¼ˆrequirements.txtï¼‰

```txt
langchain==1.2.5
faiss-cpu>=1.8.0,<2.0.0
fastapi>=0.115.0,<1.0.0
uvicorn[standard]>=0.30.0
pydantic>=2.0.0,<3.0.0
pymysql>=1.1.0
sqlalchemy>=2.0.0,<3.0.0
python-dotenv>=1.0.0
```

```json
// package.json (å‰ç«¯æ ¸å¿ƒä¾èµ–)
{
  "dependencies": {
    "react": "^18.3.0",
    "react-dom": "^18.3.0",
    "zustand": "^4.5.0",
    "tailwindcss": "^3.4.0"
  },
  "devDependencies": {
    "typescript": "^5.5.0",
    "vite": "^5.4.0",
    "@types/react": "^18.3.0"
  }
}
```
